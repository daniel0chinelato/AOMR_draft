<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AoM Retold - Draft V63 (Mobile Fixed)</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #050505;
            --text-gold: #f1c40f;
            --p1-color: #3498db;
            --p2-color: #e74c3c;
            --slot-bg: #0f0f0f;
            --slot-border: #333;
            --ban-color: #c0392b;
            --tl-pick-bg: #27ae60;
            --tl-ban-bg: #c0392b;
            --tl-reveal-bg: #ecf0f1;
            --tl-inactive: #111;
        }

        body {
            font-family: 'Cinzel', serif;
            background-color: rgba(0, 0, 0, 0.85); 
            background-image: url('fundooo.png');
            background-blend-mode: multiply;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            color: #ecf0f1;
            margin: 0; padding: 0; 
            min-height: 100vh;
            width: 100vw; 
            overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        @keyframes godReveal { 
            0% { opacity: 0; transform: scale(1.4) translateY(-15px); filter: brightness(3) contrast(0.5); } 
            30% { opacity: 1; filter: brightness(1.5) contrast(0.9); }
            100% { transform: scale(1) translateY(0); filter: brightness(1) contrast(1); opacity: 1; } 
        }

        @keyframes epicGodFloat {
            0%, 100% { transform: scale(1) translateY(0px); }
            50% { transform: scale(1.02) translateY(-8px); }
        }

        @keyframes epicGodGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 10px rgba(241, 196, 15, 0)); }
            50% { filter: brightness(1.15) drop-shadow(0 0 25px rgba(241, 196, 15, 0.6)); }
        }

        @keyframes divinePulse { 
            0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); border-color: #f1c40f; transform: scale(1); } 
            50% { box-shadow: 0 0 30px 5px rgba(241, 196, 15, 0.1); border-color: #fffaf0; transform: scale(1.03); } 
            100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); border-color: #f1c40f; transform: scale(1); } 
        }

        @keyframes urgencyPulse { 
            0% { text-shadow: 0 0 5px red; color: #ffadad; } 
            50% { text-shadow: 0 0 20px red; color: #ff0000; transform: scale(1.1); } 
            100% { text-shadow: 0 0 5px red; color: #ffadad; } 
        }
        
        @keyframes banBurn {
            0% { filter: grayscale(0) brightness(2) opacity(0); transform: scale(1.5) rotate(-90deg); }
            100% { filter: grayscale(1) contrast(1.5) brightness(0.5) opacity(1); transform: scale(1) rotate(0deg); }
        }
        
        .ban-slot.filled img.animated {
            filter: grayscale(1) contrast(1.5) brightness(0.5) !important;
            opacity: 1 !important;
            transform: scale(1) rotate(0deg) !important;
        }
        
        @keyframes timerResetFlash { 
            0% { color: #fff; transform: scale(1); } 
            50% { color: #2ecc71; transform: scale(1.2); } 
            100% { color: #fff; transform: scale(1); } 
        }
        .timer-resetting { animation: timerResetFlash 0.5s ease-out; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .host-panel { position: fixed; bottom: 20px; left: 20px; background: transparent; padding: 0; z-index: 9999; display: none; box-sizing: border-box; }
        .host-container { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .link-group { display: flex; align-items: center; gap: 8px; background: transparent; padding: 0; border: none; }
        .link-group label { color: #fff; font-size: 0.75em; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }
        .link-group input { background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.4); color: #fff; padding: 2px 4px; width: 220px; font-size: 0.7em; font-family: "Roboto", sans-serif; } .link-group input:focus { outline: none; border-bottom-color: #fff; }
        .copy-btn { background: transparent; color: #fff; border: 1px solid rgba(255, 255, 255, 0.4); padding: 3px 10px; font-weight: bold; cursor: pointer; font-size: 0.7em; transition: 0.3s; width: auto; border-radius: 2px; }
        .copy-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: #fff; }
        .reset-btn { background: transparent; color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.4); padding: 3px 10px; cursor: pointer; font-weight: bold; font-size: 0.7em; transition: 0.3s; border-radius: 2px; margin-top: 4px; } .reset-btn:hover { background: rgba(255, 68, 68, 0.2); border-color: #ff4444; }
        
        
        
        
        
        
        

        
        .timer-urgent { animation: urgencyPulse 0.8s infinite alternate; border-color: red; }
        
                .vs-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3vh;
            font-weight: 900;
            text-transform: uppercase;
            margin-top: 55px;
            margin-bottom: 10px;
            width: 100%;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            letter-spacing: 2px;
            flex-wrap: wrap;
            gap: 25px;
        }

                .p1-name, .p2-name {
            margin: 0;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: inherit;
            font-family: inherit;
            font-size: 4vh;
            font-weight: 400;
            min-width: 250px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .p1-name {
            color: var(--p1-color);
        }

        .p2-name {
            color: var(--p2-color);
        }

        .p1-name.active {
            text-shadow: 0 0 25px var(--p1-color), 0 0 40px var(--p1-color);
            animation: nameGlow 1.5s ease-in-out infinite;
        }

        .p2-name.active {
            text-shadow: 0 0 25px var(--p2-color), 0 0 40px var(--p2-color);
            animation: nameGlow 1.5s ease-in-out infinite;
        }

        @keyframes nameGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .p1-name:focus, .p2-name:focus {
            outline: none;
            border-bottom-color: var(--text-gold);
            text-shadow: 0 0 15px var(--text-gold);
        }

        .vs-text {
            display: none;
        }

                .timer-display {
            font-size: 1.8em;
            font-weight: 900;
            color: #fff;
            background: rgba(0,0,0,0.8);
            padding: 3px 20px;
            border-radius: 4px;
            border: 1px solid #444;
            margin-bottom: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            font-family: 'Roboto', sans-serif;
            transition: color 0.2s;
            min-width: 60px;
            text-align: center;
        }

        .timeline-container { 
            display: flex; justify-content: center; align-items: center; 
            width: 95%; max-width: 1600px; position: relative; gap: 3px; 
            padding: 5px; margin-bottom: 5px; 
            overflow-x: auto;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); 
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            scrollbar-width: none; 
        }
        .timeline-container::-webkit-scrollbar { display: none; }
        
        .t-pill { position: relative; z-index: 1; padding: 4px 8px; font-family: 'Roboto', sans-serif; font-weight: 900; font-size: 0.6em; text-transform: uppercase; letter-spacing: 1px; background: var(--tl-inactive); color: #555; border: 1px solid #222; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); white-space: nowrap; transform: skewX(-15deg); flex-shrink: 0; }
        .t-pill[data-type="PICK"], .t-pill[data-type="PICK_MAP"], .t-pill[data-type="BLIND_PICK"] { --target-bg: var(--tl-pick-bg); --target-color: #fff; }
        .t-pill[data-type="BAN"] { --target-bg: var(--tl-ban-bg); --target-color: #fff; }
        .t-pill[data-type="REVEAL"], .t-pill[data-type="REVEAL_STEP"], .t-pill[data-type="DECIDER"] { --target-bg: var(--tl-reveal-bg); --target-color: #111; }
        .t-pill.active { background: var(--target-bg); color: var(--target-color); transform: scale(1.3) skewX(-15deg); z-index: 10; box-shadow: 0 0 15px var(--target-bg); border-color: #fff; }
        .t-pill.done { background: var(--target-bg); color: var(--target-color); opacity: 0.3; filter: grayscale(0.8); transform: scale(0.9) skewX(-15deg); }

        .log-container {
            width: 80%; max-width: 800px; height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.8)); 
            border-top: 1px solid #333; border-bottom: 1px solid #333;
            margin: 0 auto 10px auto;
            overflow-y: auto; padding: 5px;
            font-family: 'Roboto', sans-serif; font-size: 0.75em; color: #888;
            text-align: center; scrollbar-width: thin; scrollbar-color: #444 #111;
        }
        .log-entry { margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.03); opacity: 0; animation: popIn 0.3s forwards; }
        .log-entry span.p1 { color: var(--p1-color); font-weight: bold; text-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
        .log-entry span.p2 { color: var(--p2-color); font-weight: bold; text-shadow: 0 0 5px rgba(231, 76, 60, 0.4); }
        .log-entry strong { color: #ddd; letter-spacing: 0.5px; }
        .log-entry span.random { color: #e67e22; font-style: italic; font-size: 0.8em; }

                

        
            50% {
                text-shadow: 0 0 50px rgba(52, 152, 219, 1),
                             0 0 100px rgba(231, 76, 60, 1),
                             0 5px 30px rgba(0,0,0,0.9);
            }
        }

                .vs-center {
            position: static;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20vh;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 20px;
            pointer-events: none;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 60px rgba(52, 152, 219, 1),
                         0 0 120px rgba(231, 76, 60, 1),
                         0 10px 35px rgba(0,0,0,0.9);
            animation: vsGlow 3s ease-in-out infinite;
            line-height: 1;
            margin: 0;
            padding: 0 2vw;
            align-self: center;
        }

        @keyframes vsGlow {
            0%, 100% {
                text-shadow: 0 0 60px rgba(52, 152, 219, 1),
                             0 0 120px rgba(231, 76, 60, 1),
                             0 10px 35px rgba(0,0,0,0.9);
            }
            50% {
                text-shadow: 0 0 90px rgba(52, 152, 219, 1),
                             0 0 180px rgba(231, 76, 60, 1),
                             0 10px 45px rgba(0,0,0,0.9);
            }
        }

        .main-container { display: flex; flex-direction: column; width: 98vw; max-width: 1900px; justify-content: flex-start; align-items: center; gap: 1vh; flex: 1; padding-bottom: 20px; }
        
        .god-groups-container { display: flex; justify-content: center; align-items: center; gap: 4vw; width: 100%; perspective: 1000px; flex-wrap: wrap; position: relative; }
        .god-group { display: flex; gap: 0.8vw; justify-content: center; width: 45%; min-width: 300px; }
        .god-group.mirror-layout { flex-direction: row-reverse; }
        
        .god-slot { 
            width: 11vw; max-width: 180px;
            aspect-ratio: 1 / 2.2; 
            background: #080808; border: 2px solid #333; 
            overflow: hidden; position: relative; 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: inset 0 0 20px #000;
            transition: all 0.3s ease-out;
        }
        
        .god-slot img { width: 100%; height: 100%; object-fit: cover; opacity: 1; }
        
        .god-slot.filled { border-color: #666; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .god-slot.filled img { animation: godReveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        body.spectator-mode .god-slot.filled:not(.slot-active) img {
            animation: godReveal 0.8s forwards, 
                       epicGodFloat 6s ease-in-out infinite 0.8s, 
                       epicGodGlow 4s ease-in-out infinite 0.8s;
        }

        .god-slot.empty::after { content: ""; position: absolute; width: 100%; height: 100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.03) 20px); }
        .p1-slot.filled { border-color: var(--p1-color); box-shadow: 0 0 15px rgba(52, 152, 219, 0.3); }
        .p2-slot.filled { border-color: var(--p2-color); box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }

        .slot-active { cursor: pointer; z-index: 20; animation: divinePulse 1.5s infinite ease-in-out !important; background: #111; }
        .slot-locked { filter: grayscale(0) !important; opacity: 1 !important; cursor: default; }
        .slot-pending-confirm { filter: saturate(0); animation: pendingPulse 0.8s infinite; }
        .slot-blind-ready { background: #111; border: 2px solid var(--text-gold); box-shadow: 0 0 15px var(--text-gold); }
        .slot-blind-ready::after { content: "PRONTO"; position: absolute; font-weight: 900; color: var(--text-gold); font-size: 1.5em; letter-spacing: 2px; text-shadow: 0 0 10px black; }
        .random-mark { position: absolute; top: 5px; right: 5px; font-size: 1.2em; z-index: 20; background: rgba(0,0,0,0.8); border-radius: 50%; width: 25px; height: 25px; display: flex; justify-content: center; align-items: center; color: #f39c12; box-shadow: 0 0 5px #000; border: 1px solid #f39c12; }

        .bans-container { display: flex; justify-content: center; gap: 3vw; width: 100%; margin-top: 0.5vh; flex-wrap: wrap; }
        .bans-wrapper { display: flex; align-items: center; background: rgba(0,0,0,0.8); padding: 6px 15px; border-radius: 4px; border: 1px solid #333; width: fit-content; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .ban-section { display: flex; gap: 8px; align-items: center; }
        .ban-section.mirror-layout { flex-direction: row-reverse; }
        .bans-wrapper.p1-wrapper { border-left: 4px solid var(--p1-color); margin-left: auto; }
        .bans-wrapper.p2-wrapper { border-right: 4px solid var(--p2-color); margin-right: auto; }
        .bans-side { width: 45%; min-width: 300px; display: flex; }
        .bans-side.left { justify-content: flex-end; } 
        .bans-side.right { justify-content: flex-start; } 
        .ban-divider { width: 1px; height: 35px; background: #444; margin: 0 12px; }

        .ban-slot { 
            width: 4vw; height: 4vw; max-width: 55px; max-height: 55px; min-width: 38px; min-height: 38px;
            background: #000; border: 1px solid #333; border-radius: 50%; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            overflow: hidden; opacity: 0.4; transition: all 0.3s;
        }
        .ban-slot.filled { opacity: 1; border-color: var(--ban-color); box-shadow: 0 0 15px var(--ban-color); }
        .ban-slot img { width: 100%; height: 100%; object-fit: cover; }
        
        .ban-slot.filled img:not(.animated) { 
            animation: banBurn 0.5s forwards;
        }
        
        .ban-slot.filled::before, .ban-slot.filled::after { content: ''; position: absolute; width: 80%; height: 3px; background-color: var(--ban-color); top: 50%; left: 50%; z-index: 5; box-shadow: 0 0 5px rgba(0,0,0,1); pointer-events: none; }
        .ban-slot.filled::before { transform: translate(-50%, -50%) rotate(45deg); }
        .ban-slot.filled::after { transform: translate(-50%, -50%) rotate(-45deg); }

        .maps-row { display: flex; justify-content: center; align-items: center; gap: 2vw; width: 100%; margin-top: 1vh; flex-wrap: wrap; }
        .map-group { display: flex; gap: 1vw; }
        .map-group.mirror-layout { flex-direction: row-reverse; }
        .map-slot { 
            width: 7vw; height: 7vw; max-width: 120px; max-height: 120px; min-width: 65px; min-height: 65px;
            background: #111; border: 1px solid #444; border-radius: 2px; 
            overflow: hidden; position: relative; 
            opacity: 1 !important; filter: none !important; 
            transition: all 0.3s; 
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        }
        .map-slot img { width: 100%; height: 100%; object-fit: cover; animation: popIn 0.5s; opacity: 1 !important; filter: none !important;}
        .map-name-label { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, black, transparent); color: #fff; font-size: 0.7em; font-family: 'Roboto', sans-serif; text-align: center; padding: 3px 0; font-weight: bold; text-transform: uppercase; z-index: 5; text-shadow: 0 2px 4px black; }

        .decider-wrapper { position: relative; z-index: 20; display:flex; flex-direction:column; align-items:center; margin: 5px 0;}
        .decider-slot { width: 9vw; height: 9vw; max-width: 150px; max-height: 150px; border: 4px solid var(--text-gold); box-shadow: 0 0 40px rgba(212, 175, 55, 0.2); transform: scale(1.05); }
        .decider-slot.filled img { animation: popIn 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .decider-label { color: var(--text-gold); font-weight: 900; font-size: 0.9em; text-shadow: 0 2px 10px #000; margin-bottom: 3px; letter-spacing: 2px; }

        .confirm-btn { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); 
            background: linear-gradient(to bottom, #2ecc71, #27ae60); 
            color: white; border: 2px solid #a2ffc9; 
            padding: 10px 40px; width: 90%; max-width: 350px;
            font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 900; 
            cursor: pointer; border-radius: 4px; 
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6); 
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: 0.2s; z-index: 200; display: none; 
            letter-spacing: 2px;
        }
        .confirm-btn:hover { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 50px rgba(46, 204, 113, 0.9); }
        .confirm-btn:active { transform: translateX(-50%) scale(0.95); }

        
        .replay-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: transparent;
            border: none;
            padding: 0;
            display: none;
            z-index: 650;
            font-family: 'Roboto', sans-serif;
            min-width: auto;
        }

        .replay-controls.active {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .replay-title {
            color: rgba(255, 255, 255, 0.6);
            font-weight: bold;
            font-size: 0.7em;
            letter-spacing: 1px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .replay-buttons {
            display: flex;
            gap: 8px;
        }

        .replay-btn {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 10px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            cursor: pointer;
            border-radius: 2px;
            transition: 0.2s;
            font-size: 0.7em;
            min-width: auto;
        }

        .replay-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #fff;
        }

        .replay-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .replay-speed label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            font-weight: bold;
        }

        .replay-speed select {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 3px 8px;
            font-size: 0.7em;
            cursor: pointer;
            border-radius: 2px;
        }

        .replay-timeline {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
            width: 250px;
        }

        .replay-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            cursor: pointer;
            border-radius: 2px;
        }

        .replay-progress-bar {
            height: 100%;
            background: #fff;
            width: 0%;
            border-radius: 2px;
        }

        .replay-time {
            font-size: 0.65em;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

                .spec-banner {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.7);
            padding: 4px 12px;
            border-radius: 3px;
            font-weight: bold;
            display: none;
            z-index: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Roboto', sans-serif;
            letter-spacing: 1px;
            font-size: 0.7em;
        }

        

        

        

        

        

        

        .replay-btn:active {
            transform: scale(0.95);
        }

        .replay-btn.playing {
            background: linear-gradient(to bottom, #27ae60, #229954);
            border-color: #2ecc71;
        }

        .replay-btn.recording {
            background: linear-gradient(to bottom, #c0392b, #a93226);
            border-color: #e74c3c;
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        

        

        

        

        

        .replay-progress-bar::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid var(--text-gold);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; }
        .modal-content { background: #111; border: 1px solid var(--text-gold); border-radius: 4px; padding: 30px; width: 90%; max-width: 1200px; height: 80vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 50px rgba(212, 175, 55, 0.1); }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 10px; }
        
        .selectable-card { 
            width: 100%; aspect-ratio: 2/3; 
            background: #1a1a1a; border: 2px solid #333; 
            border-radius: 4px; overflow: hidden; cursor: pointer; 
            transition: all 0.2s ease-out; position: relative; 
            display:flex; justify-content:center; align-items:center; text-align:center;
        }
        .selectable-card.is-map-card { aspect-ratio: 1/1 !important; }
        .selectable-card:hover { border-color: var(--text-gold); transform: translateY(-10px) scale(1.05); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .selectable-card.card-disabled { pointer-events: none; filter: grayscale(1) brightness(0.2); border-color: #222; }
        .selectable-card.banned-overlay::after { content: "BANIDO"; position: absolute; color: #e74c3c; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #e74c3c; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card.picked-overlay::after { content: "USADO"; position: absolute; color: #f1c40f; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #f1c40f; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card.protected-overlay::after { content: "EM JOGO"; position: absolute; color: #3498db; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #3498db; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s;}
        
        .selectable-card.selected {
            border: 3px solid var(--text-gold) !important;
            background: rgba(241, 196, 15, 0.2);
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.6), 0 10px 30px rgba(0,0,0,0.8);
            transform: scale(1.08);
            z-index: 20;
        }
        
        .selectable-card.selected::before {
            content: "✓ SELECIONADO";
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-gold);
            color: #000;
            font-weight: 900;
            font-family: 'Cinzel', serif;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 4px;
            letter-spacing: 1px;
            z-index: 10;
            animation: checkmarkPulse 0.5s ease-out;
        }
        
        @keyframes checkmarkPulse {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        
        .card-name-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, black, transparent); color: #fff; font-size: 0.8em; text-align: center; padding: 8px 0; font-weight: 700; text-shadow: 0 1px 3px black; }

        
                .ready-check-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('fundooo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .ready-check-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: -1;
        }

        .ready-box {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 50px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
            width: 320px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .ready-box h2 {
            color: #fff;
            font-size: 1.8em;
            margin-bottom: 30px;
            letter-spacing: 3px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.9);
            font-weight: bold;
        }
        .ready-container { display: flex; gap: 80px; flex-wrap: wrap; justify-content: center; }
        
        
        .ready-btn { background: transparent; border: 2px solid #444; color: #666; padding: 15px 40px; font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer; width: 100%; border-radius: 2px; transition: 0.3s; font-size: 1.1em; }
        .ready-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); }
        .ready-box.ready { border-color: #2ecc71; box-shadow: 0 0 40px rgba(46, 204, 113, 0.1); }
        .ready-box.ready .ready-btn { background: #27ae60; border-color: #2ecc71; color: white; cursor: default; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* Estilos para links do lobby */
        .lobby-links-container {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px 25px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 85%;
        }

        .lobby-link-item {
            margin-bottom: 10px;
        }

        .lobby-link-item:last-child {
            margin-bottom: 0;
        }

        .lobby-link-item label {
            display: block;
            color: #fff;
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 5px;
            letter-spacing: 1px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .lobby-link-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .lobby-link-input-group input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 7px 12px;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.75em;
            transition: 0.3s;
        }

        .lobby-link-input-group input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .lobby-copy-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            padding: 7px 15px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
            font-size: 0.7em;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .lobby-copy-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .lobby-copy-btn.copied {
            background: #27ae60;
            border-color: #2ecc71;
            color: #fff;
        }

        @media (max-width: 768px) {
            /* Esconder VS header original no mobile */
            
            
            /* Container principal em coluna */
            .god-groups-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 0;
                margin-top: 10px;
            }
            
            /* Grupo P1 */
            .god-group.p1-group { 
                width: 100%; 
                justify-content: center;
                position: relative;
                padding-top: 40px;
                padding-bottom: 15px;
                margin-bottom: 0;
            }
            
            /* Nome P1 acima dos picks */
            .god-group.p1-group::before {
                content: attr(data-player-name);
                position: absolute;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 1.5em;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 2px;
                color: var(--p1-color);
                text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
                white-space: nowrap;
                display: block !important;
            }
            
            /* Grupo P2 */
            .god-group.p2-group { 
                width: 100%; 
                justify-content: center;
                position: relative;
                padding-top: 40px;
                padding-bottom: 15px;
            }
            
            /* Nome P2 acima dos picks */
            .god-group.p2-group::before {
                content: attr(data-player-name);
                position: absolute;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 1.5em;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 2px;
                color: var(--p2-color);
                text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
                white-space: nowrap;
                display: block !important;
            }
            
            /* Manter ordem normal para ambos os grupos */
            .god-group.mirror-layout { 
                flex-direction: row; 
            } 
            
            .god-slot { 
                width: 18vw; 
                max-width: 90px; 
            }
            
            .bans-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 15px; 
                margin-top: 20px;
                width: 95%;
            }
            
            .bans-side { 
                justify-content: center !important; 
                width: 100%;
                max-width: 400px;
            }
            
            .bans-wrapper { 
                margin: 0 !important; 
                width: 100%;
                max-width: 380px;
                padding: 10px 15px;
            }
            
            .bans-wrapper.p1-wrapper { 
                border-left: 1px solid #333 !important; 
                border-right: 1px solid #333 !important;
                border-bottom: 4px solid var(--p1-color);
                border-top: 1px solid #333;
            }
            
            .bans-wrapper.p2-wrapper { 
                border-left: 1px solid #333 !important; 
                border-right: 1px solid #333 !important;
                border-top: 4px solid var(--p2-color);
                border-bottom: 1px solid #333;
            }
            
            .bans-side.left {
                order: 1;
            }
            
            .bans-side.right {
                order: 2;
            }
            
            .ban-slot {
                width: 45px;
                height: 45px;
                min-width: 45px;
                min-height: 45px;
            }

            .maps-row { 
                flex-direction: column; 
                gap: 10px; 
            }
            
            .map-group { 
                justify-content: center; 
            }
            
            .log-container { 
                width: 95%; 
                height: 60px; 
                font-size: 0.7em; 
            }
            
                    .vs-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3vh;
            font-weight: 900;
            text-transform: uppercase;
            margin-top: 55px;
            margin-bottom: 10px;
            width: 100%;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            letter-spacing: 2px;
            flex-wrap: wrap;
            gap: 25px;
        }

                .p1-name, .p2-name {
            margin: 0;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: inherit;
            font-family: inherit;
            font-size: 4vh;
            font-weight: 400;
            min-width: 250px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .p1-name {
            color: var(--p1-color);
        }

        .p2-name {
            color: var(--p2-color);
        }

        .p1-name.active {
            text-shadow: 0 0 25px var(--p1-color), 0 0 40px var(--p1-color);
            animation: nameGlow 1.5s ease-in-out infinite;
        }

        .p2-name.active {
            text-shadow: 0 0 25px var(--p2-color), 0 0 40px var(--p2-color);
            animation: nameGlow 1.5s ease-in-out infinite;
        }

        @keyframes nameGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .p1-name:focus, .p2-name:focus {
            outline: none;
            border-bottom-color: var(--text-gold);
            text-shadow: 0 0 15px var(--text-gold);
        }

        .vs-text {
            display: none;
        }

                .timer-display {
            font-size: 1.8em;
            font-weight: 900;
            color: #fff;
            background: rgba(0,0,0,0.8);
            padding: 3px 20px;
            border-radius: 4px;
            border: 1px solid #444;
            margin-bottom: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            font-family: 'Roboto', sans-serif;
            transition: color 0.2s;
            min-width: 60px;
            text-align: center;
        }

        .timeline-container { 
                justify-content: flex-start; 
                padding-left: 20px; 
            }
            
            .t-pill { 
                font-size: 0.55em; 
                padding: 3px 6px; 
            }
            
            .confirm-btn { 
                padding: 8px 16px; 
                font-size: 1em; 
                bottom: 10px; 
            }
            
            
            
            
            
            
            
            
        }
    
        .credits {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.7em;
            color: #fff;
            font-family: 'Roboto', sans-serif;
            text-align: right;
            line-height: 1.6;
            z-index: 100;
            font-weight: bold;
        }

        .credits a {
            color: #fff;
            text-decoration: none;
            transition: 0.3s;
        }

        .credits a:hover {
            color: var(--text-gold);
        }
    
        /* Responsivo - Tablet */
        @media (max-width: 1024px) {
            .vs-header {
                gap: 20px;
            }

            .p1-name, .p2-name {
                font-size: 3.5vh;
                min-width: 200px;
            }

            .timer-display {
                font-size: 1.6em;
                padding: 3px 18px;
            }

            .vs-center {
                font-size: 12vh;
            }
        }

        /* Responsivo - Mobile */
        @media (max-width: 768px) {
            .vs-header {
                display: none;
            }

            .main-container {
                gap: 2vh;
            }

            .god-groups-container {
                flex-direction: column;
                gap: 30px;
            }

            .god-group {
                width: 100%;
                position: relative;
                padding-top: 50px;
            }

            /* Nomes acima dos god pickers em mobile */
            .god-group::before {
                content: attr(data-player-name);
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                font-family: 'Cinzel', serif;
                font-size: 3vh;
                font-weight: 400;
                text-transform: uppercase;
                letter-spacing: 3px;
                text-shadow: 0 2px 10px rgba(0,0,0,0.8);
                z-index: 10;
            }

            .p1-group::before {
                color: var(--p1-color);
            }

            .p2-group::before {
                color: var(--p2-color);
            }

            .p1-group.active::before {
                text-shadow: 0 0 25px var(--p1-color), 0 0 40px var(--p1-color);
                animation: nameGlow 1.5s ease-in-out infinite;
            }

            .p2-group.active::before {
                text-shadow: 0 0 25px var(--p2-color), 0 0 40px var(--p2-color);
                animation: nameGlow 1.5s ease-in-out infinite;
            }

            .vs-center {
                position: relative;
                display: block;
                font-size: 6vh;
                letter-spacing: 6px;
                padding: 25px 0;
                margin: 0;
                text-align: center;
                text-shadow: 0 0 30px rgba(52, 152, 219, 1),
                             0 0 60px rgba(231, 76, 60, 1),
                             0 5px 20px rgba(0,0,0,0.9);
            }

            .god-slot {
                width: 18vw;
                height: 18vw;
                max-width: 90px;
                max-height: 90px;
            }

            .timeline-container {
                width: 98%;
                gap: 3px;
            }

            .t-pill {
                padding: 3px 6px;
                font-size: 0.55em;
            }

            .log-container {
                width: 95%;
                height: 50px;
                font-size: 0.7em;
            }

            .bans-container {
                flex-direction: column;
                gap: 15px;
            }

            .bans-side {
                width: 100%;
                justify-content: center !important;
            }

            .ban-slot {
                width: 60px;
                height: 60px;
            }

            .maps-row {
                flex-wrap: wrap;
                gap: 12px;
            }

            .map-slot {
                width: 90px;
                height: 90px;
            }

            .decider-slot {
                width: 110px;
                height: 110px;
            }

            /* Host panel com proteção em mobile */
            .host-panel {
                background: rgba(0, 0, 0, 0.85);
                padding: 10px;
                border-radius: 4px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Mobile pequeno */
        @media (max-width: 480px) {
            .god-group {
                padding-top: 45px;
            }

            .god-group::before {
                font-size: 2.5vh;
                top: 8px;
            }

            .god-slot {
                width: 16vw;
                height: 16vw;
                max-width: 75px;
                max-height: 75px;
            }

            .ban-slot {
                width: 55px;
                height: 55px;
            }

            .map-slot {
                width: 80px;
                height: 80px;
            }

            .decider-slot {
                width: 100px;
                height: 100px;
            }

            .t-pill {
                font-size: 0.5em;
            }

            .log-container {
                height: 45px;
                font-size: 0.65em;
            }
        }

    </style>
</head>
<body>

    <div id="hostPanel" class="host-panel">
        <div class="host-container">
            <span style="color:#fff; font-weight:bold; font-size:0.8em;">HOST:</span>
            <div class="link-group"><label>P2:</label><input type="text" id="linkP2" value="Gerando..." readonly onclick="this.select()"><button class="copy-btn" onclick="copyLink('linkP2', this)">COPIAR</button></div>
            <div class="link-group"><label>SPEC:</label><input type="text" id="linkSpec" value="Gerando..." readonly onclick="this.select()"><button class="copy-btn" onclick="copyLink('linkSpec', this)">COPIAR</button></div>
            <button class="reset-btn" onclick="resetDraft()">RESET</button>
        </div>
    </div>

    <div id="readyOverlay" class="ready-check-overlay">
        <h1 style="color:#fff; margin-bottom:20px; font-size: 3.5em; text-shadow: 0 0 20px rgba(0,0,0,0.8); letter-spacing: 5px; text-align:center;">LOBBY DE ESPERA</h1>
        
        <div id="lobbyLinks" class="lobby-links-container" style="display:none;">
            <div class="lobby-link-item">
                <label>LINK JOGADOR 2:</label>
                <div class="lobby-link-input-group">
                    <input type="text" id="linkP2Lobby" readonly>
                    <button class="lobby-copy-btn" onclick="copyLobbyLink('linkP2Lobby', this)">COPIAR</button>
                </div>
            </div>
            <div class="lobby-link-item">
                <label>LINK ESPECTADOR:</label>
                <div class="lobby-link-input-group">
                    <input type="text" id="linkSpecLobby" readonly>
                    <button class="lobby-copy-btn" onclick="copyLobbyLink('linkSpecLobby', this)">COPIAR</button>
                </div>
            </div>
        </div>
        
        <div class="ready-container">
            <div id="p1ReadyBox" class="ready-box">
                <h2>JOGADOR 1</h2>
                <button id="btnReadyP1" class="ready-btn" onclick="toggleReady('p1')">CONFIRMAR</button>
            </div>
            <div id="p2ReadyBox" class="ready-box">
                <h2>JOGADOR 2</h2>
                <button id="btnReadyP2" class="ready-btn" onclick="toggleReady('p2')">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="specBanner" class="spec-banner">ESPECTADOR</div>

    <div id="replayControls" class="replay-controls">
        <div class="replay-title">⏯️ Replay do Draft</div>
        
        <div class="replay-buttons">
            <button id="btnRewind" class="replay-btn" onclick="replayRewind()">⏮️ Início</button>
            <button id="btnPlayPause" class="replay-btn" onclick="replayTogglePlay()">▶️ Play</button>
        </div>

        <div class="replay-speed">
            <label>Velocidade:</label>
            <select id="replaySpeed" onchange="updateReplaySpeed()">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
            </select>
        </div>

        <div class="replay-timeline">
            <div class="replay-progress" onclick="seekReplay(event)">
                <div id="replayProgressBar" class="replay-progress-bar"></div>
            </div>
            <div id="replayTime" class="replay-time">0 / 0</div>
        </div>
    </div>

    <div class="vs-header">
        <input class="p1-name" id="p1NameInput" oninput="syncPlayerName('p1', this.value)">
        <div id="timerDisplay" class="timer-display">45</div>
        <input class="p2-name" id="p2NameInput" oninput="syncPlayerName('p2', this.value)">
    </div>

    <div class="timeline-container">
        <div id="timelineSteps" style="display:flex; gap:4px;"></div>
    </div>

    <div id="logContainer" class="log-container"></div>

    <div class="info-bar">
        <div id="phaseDisplay" style="display:none;"></div>
    </div>

    <div class="main-container">
        <div class="god-groups-container">
            <div class="god-group mirror-layout p1-group">
                <div id="p1-god-0" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 0)"></div>
                <div id="p1-god-1" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 1)"></div>
                <div id="p1-god-2" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 2)"></div>
                <div id="p1-god-3" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 3)"></div>
                <div id="p1-god-4" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 4)"></div>
            </div>

            <div class="vs-center">VS</div>

            <div class="god-group p2-group">
                <div id="p2-god-0" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 0)"></div>
                <div id="p2-god-1" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 1)"></div>
                <div id="p2-god-2" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 2)"></div>
                <div id="p2-god-3" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 3)"></div>
                <div id="p2-god-4" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 4)"></div>
            </div>
        </div>

        <div class="bans-container">
            <div class="bans-side left">
                <div class="bans-wrapper p1-wrapper">
                    <div class="ban-section mirror-layout">
                        <div id="p1-banmap-0" class="ban-slot" onclick="clickSlot('p1', 'banmap', 0)"></div>
                        <div id="p1-banmap-1" class="ban-slot" onclick="clickSlot('p1', 'banmap', 1)"></div>
                        <div id="p1-banmap-2" class="ban-slot" onclick="clickSlot('p1', 'banmap', 2)"></div>
                    </div>
                    <div class="ban-divider"></div>
                    <div class="ban-section mirror-layout">
                        <div id="p1-bangod-0" class="ban-slot" onclick="clickSlot('p1', 'bangod', 0)"></div>
                        <div id="p1-bangod-1" class="ban-slot" onclick="clickSlot('p1', 'bangod', 1)"></div>
                        <div id="p1-bangod-2" class="ban-slot" onclick="clickSlot('p1', 'bangod', 2)"></div>
                    </div>
                </div>
            </div>
            <div class="bans-side right">
                <div class="bans-wrapper p2-wrapper">
                    <div class="ban-section">
                        <div id="p2-bangod-0" class="ban-slot" onclick="clickSlot('p2', 'bangod', 0)"></div>
                        <div id="p2-bangod-1" class="ban-slot" onclick="clickSlot('p2', 'bangod', 1)"></div>
                        <div id="p2-bangod-2" class="ban-slot" onclick="clickSlot('p2', 'bangod', 2)"></div>
                    </div>
                    <div class="ban-divider"></div>
                    <div class="ban-section">
                        <div id="p2-banmap-0" class="ban-slot" onclick="clickSlot('p2', 'banmap', 0)"></div>
                        <div id="p2-banmap-1" class="ban-slot" onclick="clickSlot('p2', 'banmap', 1)"></div>
                        <div id="p2-banmap-2" class="ban-slot" onclick="clickSlot('p2', 'banmap', 2)"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="maps-row">
            <div class="map-group mirror-layout">
                <div id="map-0" class="map-slot" onclick="clickSlot('map', 'map', 0)"></div>
                <div id="map-1" class="map-slot" onclick="clickSlot('map', 'map', 1)"></div>
            </div>
            <div class="decider-wrapper">
                <span class="decider-label">MAPA 1 (DECIDER)</span>
                <div id="map-2" class="map-slot decider-slot"></div>
            </div>
            <div class="map-group">
                <div id="map-3" class="map-slot" onclick="clickSlot('map', 'map', 3)"></div>
                <div id="map-4" class="map-slot" onclick="clickSlot('map', 'map', 4)"></div>
            </div>
        </div>
    </div>

    <button id="confirmBtn" class="confirm-btn" onclick="confirmTurn()">CONFIRMAR</button>

    <div id="selectionModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h2 id="modalTitle" style="color:var(--text-gold); margin-top:0; text-align: center; font-size: 2em; letter-spacing: 3px; text-transform: uppercase;">Selecione</h2>
            <div id="modalGrid" class="selection-grid"></div>
        </div>
    </div>

    <script>
        const godsData = [
            {n:"Zeus", img:"zeus_portrait.png"}, {n:"Poseidon", img:"poseidon_portrait.png"}, {n:"Hades", img:"hades_portrait.png"},
            {n:"Isis", img:"isis_portrait.png"}, {n:"Ra", img:"ra_portrait.png"}, {n:"Set", img:"set_portrait.png"},
            {n:"Odin", img:"odin_portrait.png"}, {n:"Thor", img:"thor_portrait.png"}, {n:"Loki", img:"loki_portrait.png"}, {n:"Freyr", img:"freyr_portrait.png"},
            {n:"Kronos", img:"kronos_portrait.png"}, {n:"Gaia", img:"gaia_portrait.png"}, {n:"Oranos", img:"oranos_portrait.png"},
            {n:"Fu Xi", img:"fuxi_portrait.png"}, {n:"Nu Wa", img:"nuwa_portrait.png"}, {n:"Shennong", img:"shennong_portrait.png"},
            {n:"Amaterasu", img:"amaterasu_portrait.png"}, {n:"Tsukuyomi", img:"tsukuyomi_portrait.png"}, {n:"Susanoo", img:"susanoo_portrait.png"}
        ];

        const mapsData = [
            {n:"Air", img:"https://i.ibb.co/nsmbmGX9/air.png"}, {n:"Alfheim", img:"https://i.ibb.co/8gLtp62y/alfheim.png"},
            {n:"Blue Lagoon", img:"https://i.ibb.co/RpYKNMK7/blue-lagoon.png"}, {n:"Elysium", img:"https://i.ibb.co/JW3DNSC2/elysium.png"},
            {n:"Ghost Lake", img:"https://i.ibb.co/7ttqfhXs/ghost-lake.png"}, {n:"Giza", img:"https://i.ibb.co/s9nc4qyq/giza.png"},
            {n:"Kii", img:"https://i.ibb.co/VWZwbrvJ/kii.png"}, {n:"Marsh", img:"https://i.ibb.co/rKV4bTYq/marsh.png"},
            {n:"Mediterranean", img:"https://i.ibb.co/MDN5Qynb/mediterranean.png"}, {n:"Megalopolis", img:"https://i.ibb.co/b5b9XhQ2/megalopolis.png"},
            {n:"Nile Shallows", img:"https://i.ibb.co/dsRLZMQ9/nile-shallows.png"}, {n:"Oasis", img:"https://i.ibb.co/vRfNt3N/oasis.png"},
            {n:"Savannah", img:"https://i.ibb.co/rG5mywpB/savannah.png"}, {n:"Steppe", img:"https://i.ibb.co/fG1Hc99D/steppe.png"},
            {n:"Tundra", img:"https://i.ibb.co/k2yfvvvQ/tundra.png"}, {n:"Valley of Kings", img:"https://i.ibb.co/C33ZV2Qp/valley-of-kings.png"},
            {n:"Watering Hole", img:"https://i.ibb.co/N6WMy1xr/watering-hole.png"}
        ];

        const GOD_BLOCKS = [
            { label: "PICK", type: "PICK", phases: [0] }, 
            { label: "REVEAL", type: "REVEAL", phases: [] }, 
            { label: "BAN 1", type: "BAN", phases: [2, 3] }, 
            { label: "BAN 2", type: "BAN", phases: [4, 5] }, 
            { label: "BAN 3", type: "BAN", phases: [6, 7] }, 
            { label: "PICK", type: "PICK", phases: [8,9,10,11,12,13,14,15] }, 
            { label: "REVEAL", type: "REVEAL", phases: [] }
        ];
        
        const MAP_BLOCKS = [
            { label: "BAN 1", type: "BAN", phases: [16, 17] }, 
            { label: "BAN 2", type: "BAN", phases: [18, 19] }, 
            { label: "BAN 3", type: "BAN", phases: [20, 21] }, 
            { label: "PICK", type: "PICK", phases: [22] }, 
            { label: "PICK", type: "PICK", phases: [23] }, 
            { label: "PICK", type: "PICK", phases: [24] }, 
            { label: "PICK", type: "PICK", phases: [25] }, 
            { label: "REVEAL", type: "REVEAL", phases: [26] }
        ];

        function getTimelineState(phase) {
            let context = 'GODS';
            let index = 0;
            if (phase < 16) { 
                context = 'GODS';
                if (phase === 0) index = 0; 
                else if (phase === 1) index = 1; 
                else if (phase <= 3) index = 2; 
                else if (phase <= 5) index = 3; 
                else if (phase <= 7) index = 4; 
                else if (phase <= 14) index = 5; 
                else if (phase === 15) index = 6;
            } else { 
                context = 'MAPS';
                if (phase <= 17) index = 0; 
                else if (phase <= 19) index = 1; 
                else if (phase <= 21) index = 2; 
                else if (phase === 22) index = 3; 
                else if (phase === 23) index = 4; 
                else if (phase === 24) index = 5; 
                else if (phase === 25) index = 6; 
                else if (phase >= 26) index = 7;
            }
            return { context, index };
        }

        const TIMELINE = [
            { label: "G1 PICK", p1: "p1-god-0", p2: "p2-god-0", type: "BLIND_PICK" }, 
            { label: "G1 REVEAL", type: "REVEAL_STEP" },
            { label: "P1 BAN GOD 1", p1: "p1-bangod-0", p2: null, type: "BAN" }, 
            { label: "P2 BAN GOD 1", p1: null, p2: "p2-bangod-0", type: "BAN" },
            { label: "P2 BAN GOD 2", p1: null, p2: "p2-bangod-1", type: "BAN" }, 
            { label: "P1 BAN GOD 2", p1: "p1-bangod-1", p2: null, type: "BAN" },
            { label: "P1 BAN GOD 3", p1: "p1-bangod-2", p2: null, type: "BAN" }, 
            { label: "P2 BAN GOD 3", p1: null, p2: "p2-bangod-2", type: "BAN" },
            { label: "G2 PICK", p1: "p1-god-1", p2: "p2-god-1", type: "BLIND_PICK" }, 
            { label: "G2 REVEAL", type: "REVEAL_STEP" },
            { label: "G3 PICK", p1: "p1-god-2", p2: "p2-god-2", type: "BLIND_PICK" }, 
            { label: "G3 REVEAL", type: "REVEAL_STEP" },
            { label: "G4 PICK", p1: "p1-god-3", p2: "p2-god-3", type: "BLIND_PICK" }, 
            { label: "G4 REVEAL", type: "REVEAL_STEP" },
            { label: "G5 PICK", p1: "p1-god-4", p2: "p2-god-4", type: "BLIND_PICK" }, 
            { label: "G5 REVEAL", type: "REVEAL_STEP" },
            { label: "P1 BAN MAP 1", p1: "p1-banmap-0", p2: null, type: "BAN" }, 
            { label: "P2 BAN MAP 1", p1: null, p2: "p2-banmap-0", type: "BAN" },
            { label: "P2 BAN MAP 2", p1: null, p2: "p2-banmap-1", type: "BAN" }, 
            { label: "P1 BAN MAP 2", p1: "p1-banmap-1", p2: null, type: "BAN" },
            { label: "P1 BAN MAP 3", p1: "p1-banmap-2", p2: null, type: "BAN" }, 
            { label: "P2 BAN MAP 3", p1: null, p2: "p2-banmap-2", type: "BAN" },
            { label: "PICK MAP 1", p1: "map-0", p2: null, type: "PICK_MAP" }, 
            { label: "PICK MAP 2", p1: null, p2: "map-3", type: "PICK_MAP" },
            { label: "PICK MAP 3", p1: "map-1", p2: null, type: "PICK_MAP" }, 
            { label: "PICK MAP 4", p1: null, p2: "map-4", type: "PICK_MAP" },
            { label: "DECIDER", p1: "DECIDER", p2: "DECIDER", type: "DECIDER" }, 
            { label: "FINAL", p1: null, p2: null }
        ];

        let state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [], p1Name: "[CAOK] LIGHT", p2Name: "[CAOK] PAIN" };
        let myRole = 'host'; 
        let peer = null; 
        let connections = []; 
        let currentModalTarget = null;
        let isOfflineMode = false;
        let currentContext = 'GODS';
        
        let timerInterval = null;
        let timeLeft = 45;
        let isTransitioning = false;

        let replayHistory = []; 
        let replayIndex = -1; 
        let isReplayMode = false; 
        let replayInterval = null; 
        let replaySpeed = 1; 
        let isRecording = false; 
        let recordingStartTime = 0;
        let currentDraftId = null; 

        function syncPlayerName(player, value) {
            if (player === 'p1') {
                state.p1Name = value;
            } else if (player === 'p2') {
                state.p2Name = value;
            }
            
            if (!isOfflineMode && myRole === 'host') {
                broadcastState();
            } else if (!isOfflineMode && myRole === 'p2' && player === 'p2') {
                sendAction('UPDATE_NAME', { player: player, name: value });
            } else if (isOfflineMode) {
                render();
            }
        }

        function updatePlayerNames() {
            if (document.getElementById('p1NameInput').value !== state.p1Name) {
                document.getElementById('p1NameInput').value = state.p1Name;
            }
            if (document.getElementById('p2NameInput').value !== state.p2Name) {
                document.getElementById('p2NameInput').value = state.p2Name;
            }
        }

        function generateDraftId() {
            return 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveDraftToStorage() {
            if (replayHistory.length === 0) return;
            
            const draftData = {
                id: currentDraftId,
                timestamp: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                p1Name: state.p1Name,
                p2Name: state.p2Name,
                snapshots: replayHistory,
                totalActions: replayHistory.length
            };
            
            localStorage.setItem('currentDraft', JSON.stringify(draftData));
            
            let savedDrafts = JSON.parse(localStorage.getItem('savedDrafts') || '[]');
            
            const existingIndex = savedDrafts.findIndex(d => d.id === currentDraftId);
            if (existingIndex >= 0) {
                savedDrafts[existingIndex] = draftData;
            } else {
                savedDrafts.push(draftData);
            }
            
            if (savedDrafts.length > 20) {
                savedDrafts = savedDrafts.slice(-20);
            }
            
            localStorage.setItem('savedDrafts', JSON.stringify(savedDrafts));
            
            console.log('Draft salvo: ' + draftData.totalActions + ' acoes');
        }

        function loadDraftFromStorage(draftId) {
            const savedDrafts = JSON.parse(localStorage.getItem('savedDrafts') || '[]');
            const draft = savedDrafts.find(d => d.id === draftId);
            
            if (!draft) {
                alert('Draft não encontrado!');
                return false;
            }
            
            replayHistory = draft.snapshots;
            currentDraftId = draft.id;
            state.p1Name = draft.p1Name;
            state.p2Name = draft.p2Name;
            updatePlayerNames();
            
            console.log('Draft carregado: ' + draft.totalActions + ' acoes');
            enterReplayMode();
            return true;
        }

        function loadLastDraft() {
            const currentDraft = localStorage.getItem('currentDraft');
            if (!currentDraft) return false;
            
            const draft = JSON.parse(currentDraft);
            replayHistory = draft.snapshots;
            currentDraftId = draft.id;
            state.p1Name = draft.p1Name;
            state.p2Name = draft.p2Name;
            updatePlayerNames();
            
            console.log('Ultimo draft carregado: ' + draft.totalActions + ' acoes');
            return true;
        }

        const params = new URLSearchParams(window.location.search);
        const lobbyID = params.get('lobby');
        const roleParam = params.get('role');
        const draftParam = params.get('draft'); 
        
        function saveSnapshot() {
            if (!isRecording && myRole !== 'spec') return;
            
            const snapshot = {
                timestamp: Date.now(),
                state: JSON.parse(JSON.stringify(state)),
                p1Name: state.p1Name,
                p2Name: state.p2Name
            };
            
            replayHistory.push(snapshot);
            updateReplayUI();
            
            if (replayHistory.length % 3 === 0) {
                saveDraftToStorage();
            }
        }

        function generateShareableLink() {
            if (!currentDraftId) return null;
            
            const baseUrl = window.location.href.split('?')[0];
            return baseUrl + '?role=spec&draft=' + currentDraftId;
        }

        function enterReplayMode() {
            if (replayHistory.length === 0) return;
            
            isReplayMode = true;
            replayIndex = 0;
            loadReplaySnapshot(0);
            updateReplayUI();
        }

        function exitReplayMode() {
            isReplayMode = false;
            stopReplayPlay();
            replayIndex = -1;
            updateReplayUI();
        }

        function loadReplaySnapshot(index) {
            if (index < 0 || index >= replayHistory.length) return;
            
            const snapshot = replayHistory[index];
            state = JSON.parse(JSON.stringify(snapshot.state)); 
            state.p1Name = snapshot.p1Name;
            state.p2Name = snapshot.p2Name;
            updatePlayerNames();
            
            document.getElementById('logContainer').innerHTML = '';
            
            replayIndex = index;
            render();
            updateReplayUI();
        }

        function replayRewind() {
            if (replayHistory.length === 0) {
                alert('Nenhuma gravação disponível. Clique em "Gravar" durante um draft.');
                return;
            }
            
            stopReplayPlay();
            if (!isReplayMode) enterReplayMode();
            loadReplaySnapshot(0);
        }

        function replayTogglePlay() {
            if (replayHistory.length === 0) {
                alert('Nenhuma gravação disponível. Clique em "Gravar" durante um draft.');
                return;
            }

            if (!isReplayMode) enterReplayMode();
            
            const btn = document.getElementById('btnPlayPause');
            
            if (replayInterval) {
                stopReplayPlay();
            } else {
                startReplayPlay();
            }
        }

        function startReplayPlay() {
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = '⏸️ Pausar';
            btn.classList.add('playing');
            
            const baseInterval = 1000; 
            const interval = baseInterval / replaySpeed;
            
            replayInterval = setInterval(function() {
                if (replayIndex >= replayHistory.length - 1) {
                    stopReplayPlay();
                    return;
                }
                loadReplaySnapshot(replayIndex + 1);
            }, interval);
        }

        function stopReplayPlay() {
            if (replayInterval) {
                clearInterval(replayInterval);
                replayInterval = null;
            }
            
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = '▶️ Play';
            btn.classList.remove('playing');
        }

        function updateReplaySpeed() {
            replaySpeed = parseFloat(document.getElementById('replaySpeed').value);
            
            if (replayInterval) {
                stopReplayPlay();
                startReplayPlay();
            }
        }

        function seekReplay(event) {
            if (replayHistory.length === 0) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percent = x / rect.width;
            const targetIndex = Math.floor(percent * replayHistory.length);
            
            stopReplayPlay();
            if (!isReplayMode) enterReplayMode();
            loadReplaySnapshot(Math.max(0, Math.min(targetIndex, replayHistory.length - 1)));
        }

        function updateReplayUI() {
            if (myRole !== 'spec') return;
            
            const progressBar = document.getElementById('replayProgressBar');
            const timeDisplay = document.getElementById('replayTime');
            
            if (replayHistory.length > 0 && isReplayMode) {
                const percent = (replayIndex / (replayHistory.length - 1)) * 100;
                progressBar.style.width = percent + '%';
                timeDisplay.innerText = (replayIndex + 1) + ' / ' + replayHistory.length;
            } else {
                progressBar.style.width = '0%';
                timeDisplay.innerText = '0 / ' + replayHistory.length;
            }
        }

        function init() {
            updatePlayerNames();
            if (!lobbyID) {
                myRole = 'host'; 
                document.getElementById('hostPanel').style.display = 'block'; 
                render(); 
                setupHost();
            } else {
                myRole = roleParam || 'spec'; 
                
                if (draftParam && myRole === 'spec') {
                    if (loadDraftFromStorage(draftParam)) {
                        document.getElementById('specBanner').style.display='block';
                        document.getElementById('replayControls').classList.add('active');
                        document.body.classList.add('spectator-mode');
                        console.log('Draft carregado do URL');
                        return; 
                    }
                }
                
                setupClient(lobbyID); 
                
                if(myRole==='spec') {
                    document.getElementById('specBanner').style.display='block';
                    document.getElementById('replayControls').classList.add('active');
                    document.body.classList.add('spectator-mode');
                    
                    isRecording = true;
                    currentDraftId = generateDraftId();
                    
                    if (loadLastDraft()) {
                        enterReplayMode();
                        console.log('Ultimo draft carregado automaticamente');
                    }
                }
            }
            render();
        }

        function startTimer() {
            clearInterval(timerInterval); 
            timeLeft = 45; 
            
            const el = document.getElementById('timerDisplay');
            el.innerText = "45";
            el.classList.remove('timer-urgent');
            el.classList.add('timer-resetting');
            setTimeout(function() { el.classList.remove('timer-resetting'); }, 500);
            
            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase || currentPhase.type.includes("REVEAL") || currentPhase.type === "DECIDER" || state.phaseIndex >= 27) {
                el.style.display = 'none';
                return;
            }
            
            el.style.display = 'block';
            
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const el = document.getElementById('timerDisplay');
            el.innerText = timeLeft;
            if (timeLeft <= 10) el.classList.add('timer-urgent'); 
            else el.classList.remove('timer-urgent');
        }

        function handleTimeout() {
            if (isTransitioning) return; 

            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase) return;

            if (isOfflineMode) {
                const p1Data = (currentPhase.p1 && !state.p1Ready) ? getRandomFor(currentPhase.p1) : null;
                const p2Data = (currentPhase.p2 && !state.p2Ready) ? getRandomFor(currentPhase.p2, (p1Data ? [p1Data.n] : [])) : null;

                if(p1Data) state.selections[currentPhase.p1] = { n: p1Data.n, img: p1Data.img, isRandom: true };
                if(p2Data) state.selections[currentPhase.p2] = { n: p2Data.n, img: p2Data.img, isRandom: true };

                if (currentPhase.p1) state.p1Ready = true;
                if (currentPhase.p2) state.p2Ready = true;

                checkPhaseAdvance();
                render();
            } 
            else {
                if (myRole === 'host') {
                    const p1Data = (currentPhase.p1 && !state.p1Ready) ? getRandomFor(currentPhase.p1) : null;
                    const p2Data = (currentPhase.p2 && !state.p2Ready) ? getRandomFor(currentPhase.p2, (p1Data ? [p1Data.n] : [])) : null;
                    
                    if(p1Data) processHostAction({ action: 'SELECT_RANDOM', payload: { slot: currentPhase.p1, data: p1Data } });
                    if(p2Data) processHostAction({ action: 'SELECT_RANDOM', payload: { slot: currentPhase.p2, data: p2Data } });
                }
                else if (myRole === 'p2') {
                     if (currentPhase.p2 && !state.p2Ready) {
                         const d = getRandomFor(currentPhase.p2);
                         if(d) sendAction('SELECT_RANDOM', { slot: currentPhase.p2, data: d });
                     }
                }
            }
        }

        function getRandomFor(slotId, tempExclusions) {
            if (!tempExclusions) tempExclusions = [];
            if (!slotId) return null;
            let type = slotId.includes('god') ? 'god' : 'map';
            let activePlayer = slotId.startsWith('p1') ? 'p1' : (slotId.startsWith('p2') ? 'p2' : null);
            if(!activePlayer) { 
                 const ph = TIMELINE[state.phaseIndex];
                 if(ph.p1 === slotId) activePlayer = 'p1'; 
                 else if(ph.p2 === slotId) activePlayer = 'p2';
            }

            const list = (type === 'map' || type === 'banmap') ? mapsData : godsData;
            let bannedNames = tempExclusions.slice();
            let myUsedNames = [];
            let globalUsedMaps = [];
            let opponentPickedGods = [];
            const opponentPrefix = (activePlayer === 'p1') ? 'p2-' : 'p1-';

            Object.keys(state.selections).forEach(function(key) {
                const item = state.selections[key];
                if (!item) return;
                if (key.includes('ban')) bannedNames.push(item.n);
                else {
                    if (key.includes('god')) {
                        if (key.startsWith(opponentPrefix)) opponentPickedGods.push(item.n);
                        if (key.startsWith(activePlayer + '-god-')) myUsedNames.push(item.n);
                    }
                    if (key.startsWith('map-')) globalUsedMaps.push(item.n);
                }
            });

            let validItems = list.filter(function(d) {
                if (bannedNames.includes(d.n)) return false;
                if (slotId.includes('ban') && opponentPickedGods.includes(d.n)) return false; 
                if (type === 'map' && globalUsedMaps.includes(d.n)) return false;
                if (type === 'god' && !slotId.includes('ban') && myUsedNames.includes(d.n)) return false;
                return true;
            });

            if (validItems.length > 0) return validItems[Math.floor(Math.random() * validItems.length)];
            return null;
        }

        function addLogEntry(player, type, itemName, isRandom) {
            const pName = player === 'p1' ? state.p1Name : state.p2Name;
            const logEntry = { player: player, name: pName, action: type === 'ban' ? 'baniu' : 'escolheu', item: itemName, isRandom: isRandom };
            state.logs.push(logEntry);
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            
            const currentLogCount = container.querySelectorAll('.log-entry').length;
            const newLogs = state.logs.slice(currentLogCount);
            
            newLogs.forEach(function(log) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                let playerClass = log.player === 'p1' ? 'p1' : 'p2';
                let randomText = log.isRandom ? " <span class='random'>(Aleatório ❓)</span>" : "";
                entry.innerHTML = "<span class='" + playerClass + "'>" + log.name + "</span> " + log.action + " <strong>" + log.item + "</strong>" + randomText;
                container.appendChild(entry);
            });
            
            setTimeout(function() { container.scrollTop = container.scrollHeight; }, 10);
        }

        function toggleReady(player) {
            let allowed = false;
            
            if(isOfflineMode) {
                allowed = true;
            } else {
                if (myRole === 'host') {
                    if (player === 'p1') allowed = true;
                    if (player === 'p2' && connections.length === 0) allowed = true;
                }
                if (myRole === 'p2' && player === 'p2') allowed = true;
            }

            if (allowed) {
                if (isOfflineMode) {
                    if (player === 'p1') state.p1Presence = !state.p1Presence;
                    if (player === 'p2') state.p2Presence = !state.p2Presence;
                    checkReadyStart();
                    render();
                } else {
                    sendAction('TOGGLE_READY', { player: player });
                }
            }
        }

        function checkReadyStart() {
            if (state.p1Presence && state.p2Presence) {
                setTimeout(function() {
                    state.phaseIndex = 0; 
                    if (!isOfflineMode) {
                        broadcastState();
                        if (myRole === 'host') startTimer();
                    } else {
                        startTimer(); 
                        render();
                    }
                }, 500);
            }
        }

        function renderTimeline() {
            if (state.phaseIndex === -1) return;
            const tlState = getTimelineState(state.phaseIndex);
            
            if (currentContext !== tlState.context || document.getElementById('timelineSteps').children.length === 0) {
                currentContext = tlState.context;
                const container = document.getElementById('timelineSteps');
                container.innerHTML = '';
                const blocks = (currentContext === 'GODS') ? GOD_BLOCKS : MAP_BLOCKS;
                blocks.forEach(function(block, i) {
                    const el = document.createElement('div');
                    el.className = 't-pill';
                    el.innerText = block.label;
                    el.setAttribute('data-type', block.type);
                    el.id = 'tpill-' + i;
                    container.appendChild(el);
                });
            }
            const total = (currentContext === 'GODS') ? GOD_BLOCKS.length : MAP_BLOCKS.length;
            for(let i=0; i<total; i++) {
                const el = document.getElementById('tpill-' + i);
                if(!el) continue;
                el.className = 't-pill'; 
                if (i < tlState.index) el.classList.add('done');
                else if (i === tlState.index) el.classList.add('active');
            }
        }

        function sendAction(actionType, payload) {
            const msg = { type: 'ACTION', action: actionType, payload: payload, role: myRole };
            if (myRole === 'host') processHostAction(msg);
            else if (connections[0]) connections[0].send(msg);
        }

        function processHostAction(msg) {
            if (msg.action === 'SELECT') {
                state.selections[msg.payload.slot] = msg.payload.data;
            } 
            else if (msg.action === 'SELECT_RANDOM') {
                state.selections[msg.payload.slot] = { n: msg.payload.data.n, img: msg.payload.data.img, isRandom: true };
                let current = TIMELINE[state.phaseIndex];
                if (current.p1 === msg.payload.slot) state.p1Ready = true;
                if (current.p2 === msg.payload.slot) state.p2Ready = true;
                checkPhaseAdvance();
            }
            else if (msg.action === 'CONFIRM') {
                if (msg.role === 'host' || msg.role === 'p1') state.p1Ready = true;
                if (msg.role === 'p2') state.p2Ready = true;
                checkPhaseAdvance();
            }
            else if (msg.action === 'TOGGLE_READY') {
                if (msg.payload.player === 'p1') state.p1Presence = !state.p1Presence;
                if (msg.payload.player === 'p2') state.p2Presence = !state.p2Presence;
                checkReadyStart();
            }
            else if (msg.action === 'UPDATE_NAME') {
                if (msg.payload.player === 'p1') state.p1Name = msg.payload.name;
                if (msg.payload.player === 'p2') state.p2Name = msg.payload.name;
            }
            else if (msg.action === 'RESET') {
                const currentP1Name = state.p1Name || "[CAOK] LIGHT";
                const currentP2Name = state.p2Name || "[CAOK] PAIN";
                state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [], p1Name: currentP1Name, p2Name: currentP2Name };
                document.getElementById('logContainer').innerHTML = '';
                updatePlayerNames();
            }
            broadcastState();
        }

        function broadcastState() {
            render();
            saveSnapshot(); 
            if(!isOfflineMode) connections.forEach(function(c) { c.send({ type: 'STATE', state: state }); });
        }

        function clickSlot(player, type, index) {
            if (state.phaseIndex === -1) return; 
            let slotId = (player === 'map') ? ('map-' + index) : (player + '-' + type + '-' + index);
            if (myRole === 'spec') return;
            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase || currentPhase.type.includes("REVEAL") || currentPhase.type === "DECIDER") return;

            let owner = null;
            if (slotId === currentPhase.p1) owner = 'p1';
            if (slotId === currentPhase.p2) owner = 'p2';
            if (!owner) return;

            let hasPermission = false;
            if (isOfflineMode) hasPermission = true; 
            else {
                if (myRole === 'host' && owner === 'p1') hasPermission = true;
                if (myRole === 'p2' && owner === 'p2') hasPermission = true;
                if (myRole === 'host' && owner === 'p2' && connections.length === 0) hasPermission = true;
            }

            if (owner === 'p1' && state.p1Ready) hasPermission = false;
            if (owner === 'p2' && state.p2Ready) hasPermission = false;

            if (hasPermission) openModal(slotId, type, owner);
        }

        function openModal(slotId, type, activePlayer) {
            currentModalTarget = slotId;
            const grid = document.getElementById('modalGrid'); 
            grid.innerHTML = '';
            const list = (type === 'map' || type === 'banmap') ? mapsData : godsData;
            
            let bannedNames = [];
            let myUsedNames = [];
            let globalUsedMaps = [];
            const opponentPrefix = (activePlayer === 'p1') ? 'p2-' : 'p1-';
            let opponentPickedGods = [];

            Object.keys(state.selections).forEach(function(key) {
                const item = state.selections[key];
                if (!item) return;
                if (key.includes('ban')) bannedNames.push(item.n);
                else {
                    if (key.includes('god')) {
                        if (key.startsWith(opponentPrefix)) opponentPickedGods.push(item.n);
                        if (key.startsWith(activePlayer + '-god-')) myUsedNames.push(item.n);
                    }
                    if (key.startsWith('map-')) globalUsedMaps.push(item.n);
                }
            });

            list.forEach(function(d) {
                const c = document.createElement('div'); 
                c.className = 'selectable-card';
                if (type.includes('map')) c.classList.add('is-map-card');

                let disabled = false;
                if (bannedNames.includes(d.n)) { disabled = true; c.classList.add('banned-overlay'); }
                if (type === 'bangod' && opponentPickedGods.includes(d.n)) { disabled = true; c.classList.add('protected-overlay'); }
                if (type.includes('map') && globalUsedMaps.includes(d.n)) { disabled = true; c.classList.add('picked-overlay'); }
                if (type === 'god' && myUsedNames.includes(d.n)) { disabled = true; c.classList.add('picked-overlay'); }

                if (disabled) c.classList.add('card-disabled');
                c.innerHTML = "<img src='" + d.img + "' onerror=\"this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'\"><div class='card-name-overlay'>" + d.n + "</div>";
                if (!disabled) {
                    c.onclick = function(event) { 
                        selectItem(d, event.currentTarget); 
                    };
                }
                grid.appendChild(c);
            });
            
            const modal = document.getElementById('selectionModal');
            modal.style.display = 'flex';
            setTimeout(function() { modal.classList.add('show'); }, 10);
        }

        function selectItem(data, cardElement) {
            // No mobile, fecha modal e mostra botão de confirmar (comportamento original mantido)
            if (window.innerWidth <= 768) {
                // Remover seleção anterior
                document.querySelectorAll('.selectable-card.selected').forEach(function(card) {
                    card.classList.remove('selected');
                });
                
                // Adicionar classe selected no card clicado (feedback visual antes de fechar)
                if (cardElement) {
                    cardElement.classList.add('selected');
                }
                
                // Aguardar animação de seleção antes de fechar
                setTimeout(function() {
                    closeModal();
                    state.selections[currentModalTarget] = data;
                    render();
                    
                    // Mostrar botão de confirmar embaixo (comportamento original)
                    let currentPhase = TIMELINE[state.phaseIndex];
                    let p1Need = currentPhase.p1 && !state.p1Ready;
                    let p2Need = currentPhase.p2 && !state.p2Ready;
                    if(p1Need || p2Need) document.getElementById('confirmBtn').style.display = 'block';
                }, 400);
                
                return;
            }
            
            // Desktop - comportamento original
            closeModal();
            if (isOfflineMode || (myRole === 'host' && connections.length === 0)) {
                state.selections[currentModalTarget] = data;
                render();
                let currentPhase = TIMELINE[state.phaseIndex];
                let p1Need = currentPhase.p1 && !state.p1Ready;
                let p2Need = currentPhase.p2 && !state.p2Ready;
                if(p1Need || p2Need) document.getElementById('confirmBtn').style.display = 'block';
            } else {
                sendAction('SELECT', { slot: currentModalTarget, data: data });
            }
        }
        

        function confirmTurn() {
            document.getElementById('confirmBtn').style.display = 'none';
            if (isOfflineMode || (myRole === 'host' && connections.length === 0)) {
                let currentPhase = TIMELINE[state.phaseIndex];
                if(currentPhase.p1) state.p1Ready = true;
                if(currentPhase.p2) state.p2Ready = true;
                checkPhaseAdvance();
                render();
                saveSnapshot(); 
            } else {
                sendAction('CONFIRM', null);
            }
        }

        function checkPhaseAdvance() {
            let currentPhase = TIMELINE[state.phaseIndex];
            let p1OK = !currentPhase.p1 || state.p1Ready;
            let p2OK = !currentPhase.p2 || state.p2Ready;

            if (p1OK && p2OK) {
                clearInterval(timerInterval); 
                isTransitioning = true; 
                document.getElementById('timerDisplay').innerText = "--";

                if (currentPhase.p1 && state.selections[currentPhase.p1]) {
                    const item = state.selections[currentPhase.p1];
                    addLogEntry('p1', (currentPhase.p1.includes('ban') ? 'ban' : 'pick'), item.n, item.isRandom || false);
                }
                if (currentPhase.p2 && state.selections[currentPhase.p2]) {
                    const item = state.selections[currentPhase.p2];
                    addLogEntry('p2', (currentPhase.p2.includes('ban') ? 'ban' : 'pick'), item.n, item.isRandom || false);
                }
                
                renderLogs();

                setTimeout(function() {
                    state.phaseIndex++;
                    state.p1Ready = false; 
                    state.p2Ready = false;
                    isTransitioning = false;
                    
                    if (TIMELINE[state.phaseIndex].type === "REVEAL_STEP") {
                        if(isOfflineMode) render(); 
                        else broadcastState();
                        setTimeout(function() {
                            state.phaseIndex++;
                            if(isOfflineMode) { render(); startTimer(); } 
                            else { broadcastState(); if(myRole==='host') startTimer(); } 
                        }, 3000);
                        return; 
                    }

                    if (TIMELINE[state.phaseIndex].type === "DECIDER") autoPickDecider();
                    
                    if (state.phaseIndex >= TIMELINE.length - 1) {
                        saveDraftToStorage(); 
                        console.log('Draft finalizado e salvo!');
                        
                        if (myRole === 'host' && currentDraftId) {
                            setTimeout(function() {
                                const shareLink = generateShareableLink();
                                if (shareLink) {
                                    if (confirm('Draft finalizado! Deseja copiar o link de replay para compartilhar?')) {
                                        navigator.clipboard.writeText(shareLink).then(function() {
                                            alert('Link copiado! Compartilhe para que outros vejam o replay:\n\n' + shareLink);
                                        }).catch(function() {
                                            prompt('Copie este link para compartilhar o replay:', shareLink);
                                        });
                                    }
                                }
                            }, 2000);
                        }
                    }
                    
                    if(isOfflineMode) { render(); startTimer(); } 
                    else { broadcastState(); if(myRole==='host') startTimer(); }
                }, 500);
            }
        }

        function autoPickDecider() {
            let forbidden = [];
            Object.values(state.selections).forEach(function(s) { forbidden.push(s.n); });
            let available = mapsData.filter(function(m) { return !forbidden.includes(m.n); });
            if (available.length > 0) {
                let picked = available[Math.floor(Math.random() * available.length)];
                state.selections['map-2'] = picked;
                setTimeout(function() { 
                    state.phaseIndex++; 
                    if(isOfflineMode) { render(); } 
                    else { broadcastState(); }
                }, 1500);
            }
        }

        function render() {
            const overlay = document.getElementById('readyOverlay');
            if (state.phaseIndex === -1) {
                overlay.style.display = 'flex'; 
                overlay.style.opacity = '1';
                const box1 = document.getElementById('p1ReadyBox');
                const btn1 = document.getElementById('btnReadyP1');
                if (state.p1Presence) { box1.classList.add('ready'); btn1.innerText = "PRONTO"; } 
                else { box1.classList.remove('ready'); btn1.innerText = "CONFIRMAR"; }
                const box2 = document.getElementById('p2ReadyBox');
                const btn2 = document.getElementById('btnReadyP2');
                if (state.p2Presence) { box2.classList.add('ready'); btn2.innerText = "PRONTO"; } 
                else { box2.classList.remove('ready'); btn2.innerText = "CONFIRMAR"; }
                return; 
            } else {
                overlay.style.opacity = '0'; 
                setTimeout(function() { overlay.style.display = 'none'; }, 500);
            }

            updatePlayerNames();
            
            // Atualizar nomes nos grupos para mobile
            const p1Group = document.querySelector('.god-group.p1-group');
            const p2Group = document.querySelector('.god-group.p2-group');
            if (p1Group) p1Group.setAttribute('data-player-name', state.p1Name);
            if (p2Group) p2Group.setAttribute('data-player-name', state.p2Name);

            renderTimeline();
            renderLogs(); 

            const currentPhase = TIMELINE[state.phaseIndex];
            
            if(currentPhase && !currentPhase.type.includes("REVEAL") && currentPhase.type !== "DECIDER") {
                let show = false;
                if(isOfflineMode || (myRole === 'host' && connections.length === 0)) {
                    if((currentPhase.p1 && !state.p1Ready) || (currentPhase.p2 && !state.p2Ready)) show = true;
                } else {
                    if(myRole === 'host' && currentPhase.p1 && !state.p1Ready && state.selections[currentPhase.p1]) show = true;
                    if(myRole === 'p2' && currentPhase.p2 && !state.p2Ready && state.selections[currentPhase.p2]) show = true;
                }
                document.getElementById('confirmBtn').style.display = show ? 'block' : 'none';
            } else { 
                document.getElementById('confirmBtn').style.display = 'none'; 
            }

            const allSlots = document.querySelectorAll('.god-slot, .ban-slot, .map-slot');
            
            allSlots.forEach(function(el) {
                const id = el.id;
                const data = state.selections[id];
                el.classList.remove('slot-active', 'slot-locked', 'slot-pending-confirm', 'slot-blind-ready');
                
                if (id.includes('ban')) {
                    if (!data) {
                        el.innerHTML = '';
                        el.classList.remove('filled');
                    } else if (!el.classList.contains('filled')) {
                        let randomMark = data.isRandom ? "<div class='random-mark'>❓</div>" : '';
                        el.innerHTML = "<img src='" + data.img + "' onerror=\"this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'\">" + randomMark;
                        el.classList.add('filled');
                        
                        const img = el.querySelector('img');
                        if (img) {
                            setTimeout(function() {
                                img.classList.add('animated');
                            }, 500);
                        }
                    }
                } 
                else if (id.includes('map')) {
                    if (!data) {
                        el.innerHTML = '';
                        el.classList.remove('filled');
                    } else if (!el.classList.contains('filled')) {
                        let randomMark = data.isRandom ? "<div class='random-mark'>❓</div>" : '';
                        let htmlContent = "<img src='" + data.img + "' onerror=\"this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'\">" + randomMark;
                        htmlContent += "<div class='map-name-label'>" + data.n + "</div>";
                        el.innerHTML = htmlContent;
                        el.classList.add('filled');
                    }
                }
                else {
                    if (!data) el.innerHTML = ''; 
                    else if (!el.querySelector('img')) el.innerHTML = '';

                    if (data) {
                        let hideMe = false;
                        if (currentPhase && currentPhase.type === "BLIND_PICK" && (id === currentPhase.p1 || id === currentPhase.p2)) {
                            if(isOfflineMode) { 
                                if ((id === currentPhase.p1 && state.p1Ready) || (id === currentPhase.p2 && state.p2Ready)) hideMe = true; 
                            } 
                            else { 
                                if(myRole === 'host' && connections.length === 0) { 
                                    if((id===currentPhase.p1 && state.p1Ready) || (id===currentPhase.p2 && state.p2Ready)) hideMe = true; 
                                } else {
                                    if (myRole === 'host' && id === currentPhase.p2) hideMe = true; 
                                    if (myRole === 'p2' && id === currentPhase.p1) hideMe = true; 
                                    if (myRole === 'spec') hideMe = true; 
                                }
                            }
                        }

                        if (hideMe) { 
                            el.classList.add('slot-blind-ready'); 
                            el.innerHTML = ''; 
                        }
                        else {
                            let htmlContent = '';
                            let randomMark = data.isRandom ? "<div class='random-mark'>❓</div>" : '';
                            htmlContent = "<img src='" + data.img + "' onerror=\"this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'\">" + randomMark;
                            
                            if (el.innerHTML !== htmlContent) {
                                el.innerHTML = htmlContent;
                            }
                        }
                    } else el.classList.remove('filled');
                }

                if (!currentPhase) return;

                let isActive = false;
                if (id === currentPhase.p1 || id === currentPhase.p2) isActive = true;

                if (isActive) {
                    el.classList.add('slot-active');
                    let pending = false;
                    if(data) {
                        if(isOfflineMode || (myRole === 'host' && connections.length === 0)) { 
                            if ((id === currentPhase.p1 && !state.p1Ready) || (id === currentPhase.p2 && !state.p2Ready)) pending = true; 
                        }
                        else { 
                            if ((myRole==='host' && id===currentPhase.p1 && !state.p1Ready) || (myRole==='p2' && id===currentPhase.p2 && !state.p2Ready)) pending = true; 
                        }
                    }
                    if (pending) el.classList.add('slot-pending-confirm');
                } else if (data) el.classList.add('slot-locked');
            });
        }

        function setupHost() {
            try {
                let connectionTimeout = setTimeout(function() {
                    if(!peer || !peer.id) {
                        console.log("Tempo limite excedido. Forçando modo offline.");
                        isOfflineMode = true;
                        document.getElementById('linkP2').value = "MODO OFFLINE (Auto)";
                        document.getElementById('linkP2Lobby').value = "MODO OFFLINE (Auto)";
                        render();
                    }
                }, 3000);

                peer = new Peer({ debug: 1 });
                peer.on('open', function(id) {
                    clearTimeout(connectionTimeout);
                    const u = window.location.href.split('?')[0];
                    const p2Link = u + '?lobby=' + id + '&role=p2';
                    const specLink = u + '?lobby=' + id + '&role=spec';
                    
                    // Preencher campos do painel host (canto inferior esquerdo)
                    document.getElementById('linkP2').value = p2Link;
                    document.getElementById('linkSpec').value = specLink;
                    
                    // Preencher campos do lobby (tela de espera)
                    document.getElementById('linkP2Lobby').value = p2Link;
                    document.getElementById('linkSpecLobby').value = specLink;
                    
                    // Mostrar seção de links no lobby
                    document.getElementById('lobbyLinks').style.display = 'block';
                });
                peer.on('error', function(e) { 
                    clearTimeout(connectionTimeout);
                    isOfflineMode = true; 
                    document.getElementById('linkP2').value = "MODO OFFLINE (Err)"; 
                    document.getElementById('linkP2Lobby').value = "MODO OFFLINE (Err)";
                    render();
                });
                peer.on('connection', function(c) {
                    connections.push(c);
                    c.on('open', function() { c.send({ type: 'STATE', state: state }); });
                    c.on('data', function(d) { if(d.type === 'ACTION') processHostAction(d); });
                });
            } catch(e) { 
                isOfflineMode = true; 
                render();
            }
        }

        function setupClient(h) {
            try {
                peer = new Peer();
                peer.on('open', function(id) {
                    const c = peer.connect(h);
                    c.on('open', function() { connections.push(c); });
                    c.on('data', function(d) { 
                        if(d.type === 'STATE') { 
                            const oldPhase = state.phaseIndex;
                            const wasDraftCompleted = state.draftCompleted;
                            const hadGameNumbers = state.gameNumbers && Object.keys(state.gameNumbers).length > 0;
                            
                            state = d.state; 
                            updatePlayerNames();
                            render(); 
                            saveSnapshot(); 
                            
                            // Detectar quando draft é finalizado
                            if (!wasDraftCompleted && state.draftCompleted) {
                                console.log('Draft finalizado detectado pelo cliente!');
                                showEpicTransition();
                            }
                            
                            // Detectar quando números de jogo são definidos
                            if (!hadGameNumbers && state.gameNumbers && Object.keys(state.gameNumbers).length > 0) {
                                console.log('Números de jogo definidos pelo host!');
                                const gameScreen = document.getElementById('gameSelection');
                                if (gameScreen.classList.contains('active')) {
                                    gameScreen.classList.remove('active');
                                }
                            }
                            
                            if (state.phaseIndex !== oldPhase && state.phaseIndex < 27) {
                                startTimer();
                            }
                        } 
                    });
                });
            } catch(e) { console.error(e); }
        }
        
        function copyLink(id, btnElement) { 
            const i = document.getElementById(id); 
            i.select(); 
            document.execCommand('copy'); 
            
            const originalText = btnElement.innerText;
            btnElement.innerText = "SUCESSO!";
            btnElement.style.background = "#2ecc71";
            btnElement.style.color = "#000";
            
            setTimeout(function() {
                btnElement.innerText = originalText;
                btnElement.style.background = "";
                btnElement.style.color = "";
            }, 2000);
        }

        function copyLobbyLink(id, btnElement) { 
            const i = document.getElementById(id); 
            i.select(); 
            document.execCommand('copy'); 
            
            const originalText = btnElement.innerText;
            btnElement.innerText = "COPIADO!";
            btnElement.classList.add('copied');
            
            setTimeout(function() {
                btnElement.innerText = originalText;
                btnElement.classList.remove('copied');
            }, 2000);
        }

        function closeModal(e) { 
            if(e && e.target !== document.getElementById('selectionModal')) return; 
            document.getElementById('selectionModal').classList.remove('show'); 
            setTimeout(function() { document.getElementById('selectionModal').style.display='none'; }, 300); 
        }
        
        function resetDraft() { 
            if(confirm("Reset?")) { 
                if(isOfflineMode) { 
                    const currentP1Name = state.p1Name || "[CAOK] LIGHT";
                    const currentP2Name = state.p2Name || "[CAOK] PAIN";
                    state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [], p1Name: currentP1Name, p2Name: currentP2Name }; 
                    document.getElementById('logContainer').innerHTML = '';
                    updatePlayerNames();
                    render(); 
                } else sendAction('RESET', null); 
            } 
        }

        // ============================================
        // TRANSIÇÃO ÉPICA E SELEÇÃO DE JOGOS
        // ============================================
        let gameSelections = {}; // {mapId: gameNumber}

        function showEpicTransition() {
            const epicScreen = document.getElementById('epicTransition');
            
            // Preencher nomes dos jogadores
            document.getElementById('epicP1Name').innerText = state.p1Name;
            document.getElementById('epicP2Name').innerText = state.p2Name;
            
            // Preencher deuses do P1
            const p1Gods = document.getElementById('epicP1Gods');
            p1Gods.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const godData = state.selections['p1-god-' + i];
                if (godData) {
                    const img = document.createElement('img');
                    img.src = godData.img;
                    img.style.setProperty('--i', i);
                    p1Gods.appendChild(img);
                }
            }
            
            // Preencher deuses do P2
            const p2Gods = document.getElementById('epicP2Gods');
            p2Gods.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const godData = state.selections['p2-god-' + i];
                if (godData) {
                    const img = document.createElement('img');
                    img.src = godData.img;
                    img.style.setProperty('--i', i);
                    p2Gods.appendChild(img);
                }
            }
            
            // Mostrar tela
            epicScreen.classList.add('active');
            
            // Após 4 segundos, transição para seleção de jogos
            setTimeout(function() {
                epicScreen.classList.remove('active');
                setTimeout(function() {
                    showGameSelection();
                }, 500);
            }, 4000);
        }

        function showGameSelection() {
            const gameScreen = document.getElementById('gameSelection');
            const container = document.getElementById('mapsGameContainer');
            container.innerHTML = '';
            
            // Pegar todos os mapas selecionados
            const maps = [];
            for (let i = 0; i < 7; i++) {
                const mapData = state.selections['map-' + i];
                if (mapData) {
                    maps.push({ id: 'map-' + i, data: mapData, index: i });
                }
            }
            
            // Criar cards para cada mapa
            maps.forEach(function(map, idx) {
                const card = document.createElement('div');
                card.className = 'map-game-card';
                card.style.setProperty('--i', idx);
                
                card.innerHTML = `
                    <div class="map-game-header">
                        <img src="${map.data.img}" alt="${map.data.n}" class="map-game-image" onerror="this.style.display='none'">
                        <div class="map-game-info">
                            <div class="map-game-name">${map.data.n}</div>
                            <div class="map-game-label">Mapa ${idx + 1} - Escolha o número do jogo</div>
                        </div>
                    </div>
                    <div class="map-game-selector" data-map-id="${map.id}">
                        ${generateGameButtons(map.id)}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Apenas o host pode selecionar
            if (myRole === 'host' || isOfflineMode) {
                document.querySelectorAll('.game-number-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const mapId = this.getAttribute('data-map-id');
                        const gameNum = parseInt(this.getAttribute('data-game'));
                        selectGame(mapId, gameNum, this);
                    });
                });
            } else {
                // Desabilitar botões para não-hosts
                document.querySelectorAll('.game-number-btn').forEach(function(btn) {
                    btn.disabled = true;
                    btn.style.cursor = 'not-allowed';
                    btn.style.opacity = '0.5';
                });
                
                // Esconder botão de finalizar para não-hosts
                document.getElementById('btnFinalizeGames').style.display = 'none';
                
                // Adicionar mensagem
                const footer = document.querySelector('.game-selection-footer');
                const msg = document.createElement('div');
                msg.style.cssText = 'color: #fff; font-size: 1.2em; letter-spacing: 2px; text-align: center;';
                msg.innerText = 'Aguardando o host configurar os jogos...';
                footer.insertBefore(msg, footer.firstChild);
            }
            
            gameScreen.classList.add('active');
            updateFinalizeButton();
        }

        function generateGameButtons(mapId) {
            let html = '';
            for (let i = 1; i <= 7; i++) {
                html += `<button class="game-number-btn" data-map-id="${mapId}" data-game="${i}">JOGO ${i}</button>`;
            }
            return html;
        }

        function selectGame(mapId, gameNum, btnElement) {
            // Remover seleção anterior deste mapa
            const selector = btnElement.closest('.map-game-selector');
            selector.querySelectorAll('.game-number-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            
            // Adicionar seleção nova
            btnElement.classList.add('selected');
            gameSelections[mapId] = gameNum;
            
            updateFinalizeButton();
        }

        function updateFinalizeButton() {
            const btn = document.getElementById('btnFinalizeGames');
            const totalMaps = document.querySelectorAll('.map-game-card').length;
            const selectedMaps = Object.keys(gameSelections).length;
            
            if (selectedMaps === totalMaps) {
                btn.disabled = false;
                btn.innerText = `FINALIZAR CONFIGURAÇÃO (${selectedMaps}/${totalMaps})`;
            } else {
                btn.disabled = true;
                btn.innerText = `SELECIONE TODOS OS JOGOS (${selectedMaps}/${totalMaps})`;
            }
        }

        function finalizeGameSelection() {
            // Salvar as seleções de jogos no state
            if (!state.gameNumbers) state.gameNumbers = {};
            state.gameNumbers = gameSelections;
            
            // Fechar tela de seleção
            const gameScreen = document.getElementById('gameSelection');
            gameScreen.classList.remove('active');
            
            // Salvar novamente com as informações dos jogos
            saveDraftToStorage();
            
            // Mostrar mensagem de compartilhamento (código original)
            if (myRole === 'host' && currentDraftId) {
                setTimeout(function() {
                    const shareLink = generateShareableLink();
                    if (shareLink) {
                        if (confirm('Configuração completa! Deseja copiar o link de replay para compartilhar?')) {
                            navigator.clipboard.writeText(shareLink).then(function() {
                                alert('Link copiado! Compartilhe para que outros vejam o replay:\n\n' + shareLink);
                            }).catch(function() {
                                prompt('Copie este link para compartilhar o replay:', shareLink);
                            });
                        }
                    }
                }, 500);
            }
            
            // Renderizar state final
            if (isOfflineMode) render();
            else broadcastState();
        }

        init();
    </script>

    <div class="credits">
        Criado por <strong>[CaOK] PaiN</strong><br>
        Propriedade de <a href="#" id="clanLink"><strong>Clan Age of Kings</strong></a>
    </div>

</body>
</html>
