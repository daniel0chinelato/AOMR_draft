<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AoM Retold - Draft V64 (Firebase)</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #050505;
            --text-gold: #f1c40f;
            --p1-color: #3498db;
            --p2-color: #e74c3c;
            --slot-bg: #0f0f0f;
            --slot-border: #333;
            --ban-color: #c0392b;
            --tl-pick-bg: #27ae60;
            --tl-ban-bg: #c0392b;
            --tl-reveal-bg: #ecf0f1;
            --tl-inactive: #111;
        }

        body {
            font-family: 'Cinzel', serif;
            background-color: rgba(0, 0, 0, 0.85); 
            background-image: url('fundooo.png');
            background-blend-mode: multiply;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            color: #ecf0f1;
            margin: 0; padding: 0; 
            min-height: 100vh;
            width: 100vw; 
            overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* ============ ANIMA√á√ïES ============ */
        
        /* Reveal inicial dos deuses */
        @keyframes godReveal { 
            0% { opacity: 0; transform: scale(1.4) translateY(-15px); filter: brightness(3) contrast(0.5); } 
            30% { opacity: 1; filter: brightness(1.5) contrast(0.9); }
            100% { transform: scale(1) translateY(0); filter: brightness(1) contrast(1); opacity: 1; } 
        }

        /* ANIMA√á√ÉO √âPICA - APENAS PARA ESPECTADORES */
        @keyframes epicGodFloat {
            0%, 100% { transform: scale(1) translateY(0px); }
            50% { transform: scale(1.02) translateY(-8px); }
        }

        @keyframes epicGodGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 10px rgba(241, 196, 15, 0)); }
            50% { filter: brightness(1.15) drop-shadow(0 0 25px rgba(241, 196, 15, 0.6)); }
        }

        /* Pulse divino para slots ativos */
        @keyframes divinePulse { 
            0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); border-color: #f1c40f; transform: scale(1); } 
            50% { box-shadow: 0 0 30px 5px rgba(241, 196, 15, 0.1); border-color: #fffaf0; transform: scale(1.03); } 
            100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); border-color: #f1c40f; transform: scale(1); } 
        }

        @keyframes urgencyPulse { 
            0% { text-shadow: 0 0 5px red; color: #ffadad; } 
            50% { text-shadow: 0 0 20px red; color: #ff0000; transform: scale(1.1); } 
            100% { text-shadow: 0 0 5px red; color: #ffadad; } 
        }
        
        /* BAN BURN - EXECUTA UMA VEZ APENAS */
        @keyframes banBurn {
            0% { filter: grayscale(0) brightness(2) opacity(0); transform: scale(1.5) rotate(-90deg); }
            100% { filter: grayscale(1) contrast(1.5) brightness(0.5) opacity(1); transform: scale(1) rotate(0deg); }
        }
        
        /* Garantir que bans n√£o resetem anima√ß√£o */
        .ban-slot.filled img.animated {
            filter: grayscale(1) contrast(1.5) brightness(0.5) !important;
            opacity: 1 !important;
            transform: scale(1) rotate(0deg) !important;
        }
        
        @keyframes timerResetFlash { 
            0% { color: #fff; transform: scale(1); } 
            50% { color: #2ecc71; transform: scale(1.2); } 
            100% { color: #fff; transform: scale(1); } 
        }
        .timer-resetting { animation: timerResetFlash 0.5s ease-out; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* ============ HOST PANEL ============ */
        .host-panel { position: fixed; top: 0; left: 0; width: 100%; background: #000; border-bottom: 1px solid var(--text-gold); padding: 8px; z-index: 9999; display: none; text-align: center; box-shadow: 0 5px 30px rgba(0,0,0,1); box-sizing: border-box; }
        .host-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        .link-group { display: flex; align-items: center; gap: 5px; background: #1a1a1a; padding: 4px 10px; border: 1px solid #444; border-radius: 2px; }
        .link-group label { color: var(--text-gold); font-size: 0.75em; font-weight: bold; margin-right: 5px; letter-spacing: 1px; }
        .link-group input { background: #000; border: 1px solid #333; color: #aaa; padding: 4px; width: 150px; font-size: 0.75em; font-family: sans-serif; }
        .copy-btn { background: #b8860b; color: #000; border: none; padding: 4px 12px; font-weight: bold; cursor: pointer; font-size: 0.75em; transition: 0.3s; width: 80px; }
        .copy-btn:hover { background: var(--text-gold); box-shadow: 0 0 10px var(--text-gold); }
        .reset-btn { background: #8e2b20; color: white; border: none; padding: 4px 12px; cursor: pointer; font-weight: bold; font-size: 0.75em; }
        
        /* VS HEADER - COMPACTO */
        .vs-header { display: flex; align-items: center; justify-content: center; font-size: 3vh; font-weight: 900; text-transform: uppercase; margin-top: 55px; margin-bottom: 5px; width: 100%; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.8); letter-spacing: 2px; flex-wrap: wrap; }
        .p1-name, .p2-name { margin: 0 2vw; background: transparent; border: none; border-bottom: 2px solid transparent; color: inherit; font-family: inherit; font-size: inherit; width: 30vw; min-width: 200px; text-align: center; text-shadow: 0 0 10px rgba(0,0,0,0.5); transition: 0.3s; }
        .p1-name:focus, .p2-name:focus { outline: none; border-bottom-color: var(--text-gold); text-shadow: 0 0 15px var(--text-gold); }

        /* TIMER - COMPACTO */
        .timer-display {
            font-size: 1.8em; font-weight: 900; color: #fff;
            background: rgba(0,0,0,0.8); padding: 3px 20px; border-radius: 4px;
            border: 1px solid #444; margin-bottom: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            font-family: 'Roboto', sans-serif; transition: color 0.2s;
            min-width: 60px; text-align: center;
        }
        .timer-urgent { animation: urgencyPulse 0.8s infinite alternate; border-color: red; }
        
        /* TIMELINE (SNAKE) - COMPACTO */
        .timeline-container { 
            display: flex; justify-content: center; align-items: center; 
            width: 95%; max-width: 1600px; position: relative; gap: 3px; 
            padding: 5px; margin-bottom: 5px; 
            overflow-x: auto;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); 
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            scrollbar-width: none; 
        }
        .timeline-container::-webkit-scrollbar { display: none; }
        
        .t-pill { position: relative; z-index: 1; padding: 4px 8px; font-family: 'Roboto', sans-serif; font-weight: 900; font-size: 0.6em; text-transform: uppercase; letter-spacing: 1px; background: var(--tl-inactive); color: #555; border: 1px solid #222; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); white-space: nowrap; transform: skewX(-15deg); flex-shrink: 0; }
        .t-pill[data-type="PICK"], .t-pill[data-type="PICK_MAP"], .t-pill[data-type="BLIND_PICK"] { --target-bg: var(--tl-pick-bg); --target-color: #fff; }
        .t-pill[data-type="BAN"] { --target-bg: var(--tl-ban-bg); --target-color: #fff; }
        .t-pill[data-type="REVEAL"], .t-pill[data-type="REVEAL_STEP"], .t-pill[data-type="DECIDER"] { --target-bg: var(--tl-reveal-bg); --target-color: #111; }
        .t-pill.active { background: var(--target-bg); color: var(--target-color); transform: scale(1.3) skewX(-15deg); z-index: 10; box-shadow: 0 0 15px var(--target-bg); border-color: #fff; }
        .t-pill.done { background: var(--target-bg); color: var(--target-color); opacity: 0.3; filter: grayscale(0.8); transform: scale(0.9) skewX(-15deg); }

        /* LOG SYSTEM - COMPACTO */
        .log-container {
            width: 80%; max-width: 800px; height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.8)); 
            border-top: 1px solid #333; border-bottom: 1px solid #333;
            margin: 0 auto 10px auto;
            overflow-y: auto; padding: 5px;
            font-family: 'Roboto', sans-serif; font-size: 0.75em; color: #888;
            text-align: center; scrollbar-width: thin; scrollbar-color: #444 #111;
        }
        .log-entry { margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.03); opacity: 0; animation: popIn 0.3s forwards; }
        .log-entry span.p1 { color: var(--p1-color); font-weight: bold; text-shadow: 0 0 5px rgba(52, 152, 219, 0.4); }
        .log-entry span.p2 { color: var(--p2-color); font-weight: bold; text-shadow: 0 0 5px rgba(231, 76, 60, 0.4); }
        .log-entry strong { color: #ddd; letter-spacing: 0.5px; }
        .log-entry span.random { color: #e67e22; font-style: italic; font-size: 0.8em; }

        /* ============ MAIN LAYOUT - COMPACTO ============ */
        .main-container { display: flex; flex-direction: column; width: 98vw; max-width: 1900px; justify-content: flex-start; align-items: center; gap: 1vh; flex: 1; padding-bottom: 20px; }
        
        .god-groups-container { display: flex; justify-content: center; gap: 4vw; width: 100%; perspective: 1000px; flex-wrap: wrap; }
        .god-group { display: flex; gap: 0.8vw; justify-content: center; width: 45%; min-width: 300px; }
        .god-group.mirror-layout { flex-direction: row-reverse; }
        
        /* ============ GOD SLOTS ============ */
        .god-slot { 
            width: 11vw; max-width: 180px;
            aspect-ratio: 1 / 2.2; 
            background: #080808; border: 2px solid #333; 
            overflow: hidden; position: relative; 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: inset 0 0 20px #000;
            transition: all 0.3s ease-out;
        }
        
        .god-slot img { width: 100%; height: 100%; object-fit: cover; opacity: 1; }
        
        .god-slot.filled { border-color: #666; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .god-slot.filled img { animation: godReveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        
        /* ============ ANIMA√á√ÉO √âPICA - APENAS ESPECTADORES ============ */
        body.spectator-mode .god-slot.filled:not(.slot-active) img {
            animation: godReveal 0.8s forwards, 
                       epicGodFloat 6s ease-in-out infinite 0.8s, 
                       epicGodGlow 4s ease-in-out infinite 0.8s;
        }

        .god-slot.empty::after { content: ""; position: absolute; width: 100%; height: 100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.03) 20px); }
        .p1-slot.filled { border-color: var(--p1-color); box-shadow: 0 0 15px rgba(52, 152, 219, 0.3); }
        .p2-slot.filled { border-color: var(--p2-color); box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }

        .slot-active { cursor: pointer; z-index: 20; animation: divinePulse 1.5s infinite ease-in-out !important; background: #111; }
        .slot-locked { filter: grayscale(0) !important; opacity: 1 !important; cursor: default; }
        .slot-pending-confirm { filter: saturate(0); animation: pendingPulse 0.8s infinite; }
        .slot-blind-ready { background: #111; border: 2px solid var(--text-gold); box-shadow: 0 0 15px var(--text-gold); }
        .slot-blind-ready::after { content: "PRONTO"; position: absolute; font-weight: 900; color: var(--text-gold); font-size: 1.5em; letter-spacing: 2px; text-shadow: 0 0 10px black; }
        .random-mark { position: absolute; top: 5px; right: 5px; font-size: 1.2em; z-index: 20; background: rgba(0,0,0,0.8); border-radius: 50%; width: 25px; height: 25px; display: flex; justify-content: center; align-items: center; color: #f39c12; box-shadow: 0 0 5px #000; border: 1px solid #f39c12; }

        /* ============ BANS (SEM NOMES) - COMPACTO ============ */
        .bans-container { display: flex; justify-content: center; gap: 3vw; width: 100%; margin-top: 0.5vh; flex-wrap: wrap; }
        .bans-wrapper { display: flex; align-items: center; background: rgba(0,0,0,0.8); padding: 6px 15px; border-radius: 4px; border: 1px solid #333; width: fit-content; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .ban-section { display: flex; gap: 8px; align-items: center; }
        .ban-section.mirror-layout { flex-direction: row-reverse; }
        .bans-wrapper.p1-wrapper { border-left: 4px solid var(--p1-color); margin-left: auto; }
        .bans-wrapper.p2-wrapper { border-right: 4px solid var(--p2-color); margin-right: auto; }
        .bans-side { width: 45%; min-width: 300px; display: flex; }
        .bans-side.left { justify-content: flex-end; } 
        .bans-side.right { justify-content: flex-start; } 
        .ban-divider { width: 1px; height: 35px; background: #444; margin: 0 12px; }

        .ban-slot { 
            width: 4vw; height: 4vw; max-width: 55px; max-height: 55px; min-width: 38px; min-height: 38px;
            background: #000; border: 1px solid #333; border-radius: 50%; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            overflow: hidden; opacity: 0.4; transition: all 0.3s;
        }
        .ban-slot.filled { opacity: 1; border-color: var(--ban-color); box-shadow: 0 0 15px var(--ban-color); }
        .ban-slot img { width: 100%; height: 100%; object-fit: cover; }
        
        /* CORRE√á√ÉO CR√çTICA: Adicionar classe 'animated' via JavaScript para prevenir re-anima√ß√£o */
        .ban-slot.filled img:not(.animated) { 
            animation: banBurn 0.5s forwards;
        }
        
        .ban-slot.filled::before, .ban-slot.filled::after { content: ''; position: absolute; width: 80%; height: 3px; background-color: var(--ban-color); top: 50%; left: 50%; z-index: 5; box-shadow: 0 0 5px rgba(0,0,0,1); pointer-events: none; }
        .ban-slot.filled::before { transform: translate(-50%, -50%) rotate(45deg); }
        .ban-slot.filled::after { transform: translate(-50%, -50%) rotate(-45deg); }

        /* ============ MAPS (NOME √öNICO) - COMPACTO ============ */
        .maps-row { display: flex; justify-content: center; align-items: center; gap: 2vw; width: 100%; margin-top: 1vh; flex-wrap: wrap; }
        .map-group { display: flex; gap: 1vw; }
        .map-group.mirror-layout { flex-direction: row-reverse; }
        .map-slot { 
            width: 7vw; height: 7vw; max-width: 120px; max-height: 120px; min-width: 65px; min-height: 65px;
            background: #111; border: 1px solid #444; border-radius: 2px; 
            overflow: hidden; position: relative; 
            opacity: 1 !important; filter: none !important; 
            transition: all 0.3s; 
            box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        }
        .map-slot img { width: 100%; height: 100%; object-fit: cover; animation: popIn 0.5s; opacity: 1 !important; filter: none !important;}
        .map-name-label { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, black, transparent); color: #fff; font-size: 0.7em; font-family: 'Roboto', sans-serif; text-align: center; padding: 3px 0; font-weight: bold; text-transform: uppercase; z-index: 5; text-shadow: 0 2px 4px black; }

        .decider-wrapper { position: relative; z-index: 20; display:flex; flex-direction:column; align-items:center; margin: 5px 0;}
        .decider-slot { width: 9vw; height: 9vw; max-width: 150px; max-height: 150px; border: 4px solid var(--text-gold); box-shadow: 0 0 40px rgba(212, 175, 55, 0.2); transform: scale(1.05); }
        .decider-slot.filled img { animation: popIn 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .decider-label { color: var(--text-gold); font-weight: 900; font-size: 0.9em; text-shadow: 0 2px 10px #000; margin-bottom: 3px; letter-spacing: 2px; }

        /* ============ BUTTONS & MODALS ============ */
        .confirm-btn { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); 
            background: linear-gradient(to bottom, #2ecc71, #27ae60); 
            color: white; border: 2px solid #a2ffc9; 
            padding: 10px 40px; width: 90%; max-width: 350px;
            font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 900; 
            cursor: pointer; border-radius: 4px; 
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6); 
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: 0.2s; z-index: 200; display: none; 
            letter-spacing: 2px;
        }
        .confirm-btn:hover { transform: translateX(-50%) scale(1.05); box-shadow: 0 0 50px rgba(46, 204, 113, 0.9); }
        .confirm-btn:active { transform: translateX(-50%) scale(0.95); }

        .spec-banner { position:fixed; top:80px; right:20px; background: #e67e22; color: #fff; padding: 5px 20px; border-radius: 2px; font-weight: bold; display: none; z-index: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.8); font-family: sans-serif; letter-spacing: 1px;}

        /* ============ REPLAY CONTROLS ============ */
        .replay-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--text-gold);
            border-radius: 8px;
            padding: 15px 25px;
            display: none;
            z-index: 650;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
            font-family: 'Roboto', sans-serif;
            min-width: 500px;
        }

        .replay-controls.active { display: flex; flex-direction: column; align-items: center; gap: 12px; }

        .replay-title {
            color: var(--text-gold);
            font-weight: 900;
            font-size: 1.1em;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .replay-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .replay-btn {
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            color: white;
            border: 2px solid #7f8c8d;
            padding: 8px 16px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            font-size: 0.9em;
            min-width: 80px;
        }

        .replay-btn:hover {
            background: linear-gradient(to bottom, #3d566e, #34495e);
            border-color: var(--text-gold);
            transform: scale(1.05);
        }

        .replay-btn:active {
            transform: scale(0.95);
        }

        .replay-btn.playing {
            background: linear-gradient(to bottom, #27ae60, #229954);
            border-color: #2ecc71;
        }

        .replay-btn.recording {
            background: linear-gradient(to bottom, #c0392b, #a93226);
            border-color: #e74c3c;
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }

        .replay-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ecf0f1;
            font-size: 0.85em;
        }

        .replay-speed select {
            background: #2c3e50;
            color: white;
            border: 1px solid #7f8c8d;
            padding: 4px 8px;
            border-radius: 3px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
        }

        .replay-timeline {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .replay-progress {
            flex: 1;
            height: 8px;
            background: #34495e;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            border: 1px solid #7f8c8d;
        }

        .replay-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--text-gold), #f39c12);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
            position: relative;
        }

        .replay-progress-bar::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid var(--text-gold);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .replay-time {
            color: #bdc3c7;
            font-size: 0.85em;
            min-width: 80px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        @media (max-width: 768px) {
            .replay-controls { min-width: 90%; padding: 10px 15px; }
            .replay-buttons { flex-wrap: wrap; }
            .replay-btn { min-width: 60px; padding: 6px 12px; font-size: 0.8em; }
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; }
        .modal-content { background: #111; border: 1px solid var(--text-gold); border-radius: 4px; padding: 30px; width: 90%; max-width: 1200px; height: 80vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 50px rgba(212, 175, 55, 0.1); }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 10px; }
        
        .selectable-card { 
            width: 100%; aspect-ratio: 2/3; 
            background: #1a1a1a; border: 2px solid #333; 
            border-radius: 4px; overflow: hidden; cursor: pointer; 
            transition: all 0.2s ease-out; position: relative; 
            display:flex; justify-content:center; align-items:center; text-align:center;
        }
        .selectable-card.is-map-card { aspect-ratio: 1/1 !important; }
        .selectable-card:hover { border-color: var(--text-gold); transform: translateY(-10px) scale(1.05); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .selectable-card.card-disabled { pointer-events: none; filter: grayscale(1) brightness(0.2); border-color: #222; }
        .selectable-card.banned-overlay::after { content: "BANIDO"; position: absolute; color: #e74c3c; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #e74c3c; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card.picked-overlay::after { content: "USADO"; position: absolute; color: #f1c40f; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #f1c40f; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card.protected-overlay::after { content: "EM JOGO"; position: absolute; color: #3498db; font-weight: 900; font-family: sans-serif; font-size: 1.2em; transform: rotate(-25deg); text-shadow: 0 2px 10px black; border: 3px solid #3498db; padding: 5px 10px; border-radius: 4px; opacity: 0.8; }
        .selectable-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s;}
        .card-name-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, black, transparent); color: #fff; font-size: 0.8em; text-align: center; padding: 8px 0; font-weight: 700; text-shadow: 0 1px 3px black; }

        .ready-check-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 400; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; backdrop-filter: blur(10px); }
        .ready-container { display: flex; gap: 80px; flex-wrap: wrap; justify-content: center; }
        .ready-box { background: #080808; border: 1px solid #333; padding: 40px; border-radius: 4px; text-align: center; width: 280px; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin: 10px; }
        .ready-box h2 { color: var(--text-gold); margin: 0 0 30px 0; font-size: 1.8em; letter-spacing: 2px; }
        .ready-btn { background: transparent; border: 2px solid #444; color: #666; padding: 15px 40px; font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer; width: 100%; border-radius: 2px; transition: 0.3s; font-size: 1.1em; }
        .ready-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); }
        .ready-box.ready { border-color: #2ecc71; box-shadow: 0 0 40px rgba(46, 204, 113, 0.1); }
        .ready-box.ready .ready-btn { background: #27ae60; border-color: #2ecc71; color: white; cursor: default; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* ============ RESPONSIVIDADE ============ */
        @media (max-width: 768px) {
            /* Esconder VS header original no mobile */
            .vs-header { display: none; }
            
            /* Criar novo layout mobile */
            .god-groups-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 15px;
                margin-top: 10px;
            }
            
            .god-group { 
                width: 100%; 
                justify-content: center;
                position: relative;
                padding-top: 35px;
            }
            
            /* Adicionar nome do jogador acima de cada grupo */
            .god-group::before {
                content: attr(data-player-name);
                position: absolute;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 1.5em;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 2px;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
                white-space: nowrap;
            }
            
            /* Cor espec√≠fica para cada jogador */
            .god-group.p1-group::before {
                color: var(--p1-color);
                text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            }
            
            .god-group.p2-group::before {
                color: var(--p2-color);
                text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            }
            
            /* VS entre os grupos */
            .god-group.p1-group::after {
                content: "VS";
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 1.8em;
                font-weight: 900;
                color: var(--text-gold);
                text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
                letter-spacing: 3px;
                z-index: 10;
            }
            
            /* No mobile, voltamos a ordem normal para o P1 n√£o ficar invertido */
            .god-group.mirror-layout { flex-direction: row; } 
            
            .god-slot { width: 18vw; max-width: 90px; }
            
            .bans-container { flex-direction: column-reverse; align-items: center; gap: 10px; margin-top: 30px; }
            .bans-side { justify-content: center !important; width: 100%; }
            .bans-wrapper { margin: 0 !important; border-left: 1px solid #333 !important; border-right: 1px solid #333 !important; }
            .bans-wrapper.p1-wrapper { border-bottom: 4px solid var(--p1-color); }
            .bans-wrapper.p2-wrapper { border-top: 4px solid var(--p2-color); }

            .maps-row { flex-direction: column; gap: 10px; }
            .map-group { justify-content: center; }
            
            .log-container { width: 95%; height: 60px; font-size: 0.7em; }
            .timeline-container { justify-content: flex-start; padding-left: 20px; }
            .t-pill { font-size: 0.55em; padding: 3px 6px; }
            
            .confirm-btn { padding: 8px 16px; font-size: 1em; bottom: 10px; }
            
            .replay-controls { min-width: 90%; padding: 10px 15px; }
            .replay-buttons { flex-wrap: wrap; gap: 5px; }
            .replay-btn { min-width: 45%; padding: 6px 10px; font-size: 0.8em; }
            .replay-title { font-size: 0.9em; }
        }
    </style>
</head>
<body>

    <div id="hostPanel" class="host-panel">
        <div class="host-container">
            <span style="color:#d4af37; font-weight:bold;">HOST:</span>
            <div class="link-group"><label>P2:</label><input type="text" id="linkP2" value="Gerando..." readonly onclick="this.select()"><button class="copy-btn" onclick="copyLink('linkP2', this)">COPIAR</button></div>
            <div class="link-group"><label>SPEC:</label><input type="text" id="linkSpec" value="Gerando..." readonly onclick="this.select()"><button class="copy-btn" onclick="copyLink('linkSpec', this)">COPIAR</button></div>
            <button class="reset-btn" onclick="resetDraft()">RESET</button>
        </div>
    </div>

    <div id="readyOverlay" class="ready-check-overlay">
        <h1 style="color:var(--text-gold); margin-bottom:50px; font-size: 3.5em; text-shadow: 0 0 20px rgba(0,0,0,0.8); letter-spacing: 5px; text-align:center;">LOBBY DE ESPERA</h1>
        <div class="ready-container">
            <div id="p1ReadyBox" class="ready-box">
                <h2>JOGADOR 1</h2>
                <button id="btnReadyP1" class="ready-btn" onclick="toggleReady('p1')">CONFIRMAR</button>
            </div>
            <div id="p2ReadyBox" class="ready-box">
                <h2>JOGADOR 2</h2>
                <button id="btnReadyP2" class="ready-btn" onclick="toggleReady('p2')">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="specBanner" class="spec-banner">ESPECTADOR</div>

    <div id="replayControls" class="replay-controls">
        <div class="replay-title">‚èØÔ∏è Replay do Draft</div>
        
        <div class="replay-buttons">
            <button id="btnRewind" class="replay-btn" onclick="replayRewind()">‚èÆÔ∏è In√≠cio</button>
            <button id="btnPlayPause" class="replay-btn" onclick="replayTogglePlay()">‚ñ∂Ô∏è Play</button>
        </div>

        <div class="replay-speed">
            <label>Velocidade:</label>
            <select id="replaySpeed" onchange="updateReplaySpeed()">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
            </select>
        </div>

        <div class="replay-timeline">
            <div class="replay-progress" onclick="seekReplay(event)">
                <div id="replayProgressBar" class="replay-progress-bar"></div>
            </div>
            <div id="replayTime" class="replay-time">0 / 0</div>
        </div>
    </div>

    <div class="vs-header">
        <input class="p1-name" id="p1NameInput" value="[CAOK] LIGHT">
        <span class="vs-text">VS</span>
        <input class="p2-name" id="p2NameInput" value="[CAOK] PAIN">
    </div>

    <div id="timerDisplay" class="timer-display">45</div>

    <div class="timeline-container">
        <div id="timelineSteps" style="display:flex; gap:4px;"></div>
    </div>

    <div id="logContainer" class="log-container"></div>

    <div class="info-bar">
        <div id="phaseDisplay" style="display:none;"></div>
    </div>

    <div class="main-container">
        <div class="god-groups-container">
            <div class="god-group mirror-layout p1-group" data-player-name="">
                <div id="p1-god-0" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 0)"></div>
                <div id="p1-god-1" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 1)"></div>
                <div id="p1-god-2" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 2)"></div>
                <div id="p1-god-3" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 3)"></div>
                <div id="p1-god-4" class="god-slot p1-slot" onclick="clickSlot('p1', 'god', 4)"></div>
            </div>
            <div class="god-group p2-group" data-player-name="">
                <div id="p2-god-0" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 0)"></div>
                <div id="p2-god-1" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 1)"></div>
                <div id="p2-god-2" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 2)"></div>
                <div id="p2-god-3" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 3)"></div>
                <div id="p2-god-4" class="god-slot p2-slot" onclick="clickSlot('p2', 'god', 4)"></div>
            </div>
        </div>

        <div class="bans-container">
            <div class="bans-side left">
                <div class="bans-wrapper p1-wrapper">
                    <div class="ban-section mirror-layout">
                        <div id="p1-banmap-0" class="ban-slot" onclick="clickSlot('p1', 'banmap', 0)"></div>
                        <div id="p1-banmap-1" class="ban-slot" onclick="clickSlot('p1', 'banmap', 1)"></div>
                        <div id="p1-banmap-2" class="ban-slot" onclick="clickSlot('p1', 'banmap', 2)"></div>
                    </div>
                    <div class="ban-divider"></div>
                    <div class="ban-section mirror-layout">
                        <div id="p1-bangod-0" class="ban-slot" onclick="clickSlot('p1', 'bangod', 0)"></div>
                        <div id="p1-bangod-1" class="ban-slot" onclick="clickSlot('p1', 'bangod', 1)"></div>
                        <div id="p1-bangod-2" class="ban-slot" onclick="clickSlot('p1', 'bangod', 2)"></div>
                    </div>
                </div>
            </div>
            <div class="bans-side right">
                <div class="bans-wrapper p2-wrapper">
                    <div class="ban-section">
                        <div id="p2-bangod-0" class="ban-slot" onclick="clickSlot('p2', 'bangod', 0)"></div>
                        <div id="p2-bangod-1" class="ban-slot" onclick="clickSlot('p2', 'bangod', 1)"></div>
                        <div id="p2-bangod-2" class="ban-slot" onclick="clickSlot('p2', 'bangod', 2)"></div>
                    </div>
                    <div class="ban-divider"></div>
                    <div class="ban-section">
                        <div id="p2-banmap-0" class="ban-slot" onclick="clickSlot('p2', 'banmap', 0)"></div>
                        <div id="p2-banmap-1" class="ban-slot" onclick="clickSlot('p2', 'banmap', 1)"></div>
                        <div id="p2-banmap-2" class="ban-slot" onclick="clickSlot('p2', 'banmap', 2)"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="maps-row">
            <div class="map-group mirror-layout">
                <div id="map-0" class="map-slot" onclick="clickSlot('map', 'map', 0)"></div>
                <div id="map-1" class="map-slot" onclick="clickSlot('map', 'map', 1)"></div>
            </div>
            <div class="decider-wrapper">
                <span class="decider-label">MAPA 1 (DECIDER)</span>
                <div id="map-2" class="map-slot decider-slot"></div>
            </div>
            <div class="map-group">
                <div id="map-3" class="map-slot" onclick="clickSlot('map', 'map', 3)"></div>
                <div id="map-4" class="map-slot" onclick="clickSlot('map', 'map', 4)"></div>
            </div>
        </div>
    </div>

    <button id="confirmBtn" class="confirm-btn" onclick="confirmTurn()">CONFIRMAR</button>

    <div id="selectionModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h2 id="modalTitle" style="color:var(--text-gold); margin-top:0; text-align: center; font-size: 2em; letter-spacing: 3px; text-transform: uppercase;">Selecione</h2>
            <div id="modalGrid" class="selection-grid"></div>
        </div>
    </div>

    <script>
        // ============ CONFIGURA√á√ÉO FIREBASE ============
        const firebaseConfig = {
            apiKey: "AIzaSyAgliUKQCUlKrAlRbBwRQQpRO5sBjwvOgo",
            authDomain: "aom-draft.firebaseapp.com",
            databaseURL: "https://draft-aom-default-rtdb.firebaseio.com",
            projectId: "aom-draft",
            storageBucket: "aom-draft.firebasestorage.app",
            messagingSenderId: "868281557350",
            appId: "1:868281557350:web:6813ba2322556e2e2768a7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        console.log('üî• Firebase inicializado com sucesso!');

        // ============ CONFIGURA√á√ÉO DOS DEUSES ============
        const godsData = [
            {n:"Zeus", img:"zeus_portrait.png"}, {n:"Poseidon", img:"poseidon_portrait.png"}, {n:"Hades", img:"hades_portrait.png"},
            {n:"Isis", img:"isis_portrait.png"}, {n:"Ra", img:"ra_portrait.png"}, {n:"Set", img:"set_portrait.png"},
            {n:"Odin", img:"odin_portrait.png"}, {n:"Thor", img:"thor_portrait.png"}, {n:"Loki", img:"loki_portrait.png"}, {n:"Freyr", img:"freyr_portrait.png"},
            {n:"Kronos", img:"kronos_portrait.png"}, {n:"Gaia", img:"gaia_portrait.png"}, {n:"Oranos", img:"oranos_portrait.png"},
            {n:"Fu Xi", img:"fuxi_portrait.png"}, {n:"Nu Wa", img:"nuwa_portrait.png"}, {n:"Shennong", img:"shennong_portrait.png"},
            {n:"Amaterasu", img:"amaterasu_portrait.png"}, {n:"Tsukuyomi", img:"tsukuyomi_portrait.png"}, {n:"Susanoo", img:"susanoo_portrait.png"}
        ];

        // ============ CONFIGURA√á√ÉO DOS MAPAS ============
        const mapsData = [
            {n:"Air", img:"https://i.ibb.co/nsmbmGX9/air.png"}, {n:"Alfheim", img:"https://i.ibb.co/8gLtp62y/alfheim.png"},
            {n:"Blue Lagoon", img:"https://i.ibb.co/RpYKNMK7/blue-lagoon.png"}, {n:"Elysium", img:"https://i.ibb.co/JW3DNSC2/elysium.png"},
            {n:"Ghost Lake", img:"https://i.ibb.co/7ttqfhXs/ghost-lake.png"}, {n:"Giza", img:"https://i.ibb.co/s9nc4qyq/giza.png"},
            {n:"Kii", img:"https://i.ibb.co/VWZwbrvJ/kii.png"}, {n:"Marsh", img:"https://i.ibb.co/rKV4bTYq/marsh.png"},
            {n:"Mediterranean", img:"https://i.ibb.co/MDN5Qynb/mediterranean.png"}, {n:"Megalopolis", img:"https://i.ibb.co/b5b9XhQ2/megalopolis.png"},
            {n:"Nile Shallows", img:"https://i.ibb.co/dsRLZMQ9/nile-shallows.png"}, {n:"Oasis", img:"https://i.ibb.co/vRfNt3N/oasis.png"},
            {n:"Savannah", img:"https://i.ibb.co/rG5mywpB/savannah.png"}, {n:"Steppe", img:"https://i.ibb.co/fG1Hc99D/steppe.png"},
            {n:"Tundra", img:"https://i.ibb.co/k2yfvvvQ/tundra.png"}, {n:"Valley of Kings", img:"https://i.ibb.co/C33ZV2Qp/valley-of-kings.png"},
            {n:"Watering Hole", img:"https://i.ibb.co/N6WMy1xr/watering-hole.png"}
        ];

        // ============ TIMELINE ============
        const GOD_BLOCKS = [
            { label: "PICK", type: "PICK", phases: [0] }, 
            { label: "REVEAL", type: "REVEAL", phases: [] }, 
            { label: "BAN 1", type: "BAN", phases: [2, 3] }, 
            { label: "BAN 2", type: "BAN", phases: [4, 5] }, 
            { label: "BAN 3", type: "BAN", phases: [6, 7] }, 
            { label: "PICK", type: "PICK", phases: [8,9,10,11,12,13,14,15] }, 
            { label: "REVEAL", type: "REVEAL", phases: [] }
        ];
        
        const MAP_BLOCKS = [
            { label: "BAN 1", type: "BAN", phases: [16, 17] }, 
            { label: "BAN 2", type: "BAN", phases: [18, 19] }, 
            { label: "BAN 3", type: "BAN", phases: [20, 21] }, 
            { label: "PICK", type: "PICK", phases: [22] }, 
            { label: "PICK", type: "PICK", phases: [23] }, 
            { label: "PICK", type: "PICK", phases: [24] }, 
            { label: "PICK", type: "PICK", phases: [25] }, 
            { label: "REVEAL", type: "REVEAL", phases: [26] }
        ];

        function getTimelineState(phase) {
            let context = 'GODS';
            let index = 0;
            if (phase < 16) { 
                context = 'GODS';
                if (phase === 0) index = 0; 
                else if (phase === 1) index = 1; 
                else if (phase <= 3) index = 2; 
                else if (phase <= 5) index = 3; 
                else if (phase <= 7) index = 4; 
                else if (phase <= 14) index = 5; 
                else if (phase === 15) index = 6;
            } else { 
                context = 'MAPS';
                if (phase <= 17) index = 0; 
                else if (phase <= 19) index = 1; 
                else if (phase <= 21) index = 2; 
                else if (phase === 22) index = 3; 
                else if (phase === 23) index = 4; 
                else if (phase === 24) index = 5; 
                else if (phase === 25) index = 6; 
                else if (phase >= 26) index = 7;
            }
            return { context, index };
        }

        const TIMELINE = [
            { label: "G1 PICK", p1: "p1-god-0", p2: "p2-god-0", type: "BLIND_PICK" }, 
            { label: "G1 REVEAL", type: "REVEAL_STEP" },
            { label: "P1 BAN GOD 1", p1: "p1-bangod-0", p2: null, type: "BAN" }, 
            { label: "P2 BAN GOD 1", p1: null, p2: "p2-bangod-0", type: "BAN" },
            { label: "P2 BAN GOD 2", p1: null, p2: "p2-bangod-1", type: "BAN" }, 
            { label: "P1 BAN GOD 2", p1: "p1-bangod-1", p2: null, type: "BAN" },
            { label: "P1 BAN GOD 3", p1: "p1-bangod-2", p2: null, type: "BAN" }, 
            { label: "P2 BAN GOD 3", p1: null, p2: "p2-bangod-2", type: "BAN" },
            { label: "G2 PICK", p1: "p1-god-1", p2: "p2-god-1", type: "BLIND_PICK" }, 
            { label: "G2 REVEAL", type: "REVEAL_STEP" },
            { label: "G3 PICK", p1: "p1-god-2", p2: "p2-god-2", type: "BLIND_PICK" }, 
            { label: "G3 REVEAL", type: "REVEAL_STEP" },
            { label: "G4 PICK", p1: "p1-god-3", p2: "p2-god-3", type: "BLIND_PICK" }, 
            { label: "G4 REVEAL", type: "REVEAL_STEP" },
            { label: "G5 PICK", p1: "p1-god-4", p2: "p2-god-4", type: "BLIND_PICK" }, 
            { label: "G5 REVEAL", type: "REVEAL_STEP" },
            { label: "P1 BAN MAP 1", p1: "p1-banmap-0", p2: null, type: "BAN" }, 
            { label: "P2 BAN MAP 1", p1: null, p2: "p2-banmap-0", type: "BAN" },
            { label: "P2 BAN MAP 2", p1: null, p2: "p2-banmap-1", type: "BAN" }, 
            { label: "P1 BAN MAP 2", p1: "p1-banmap-1", p2: null, type: "BAN" },
            { label: "P1 BAN MAP 3", p1: "p1-banmap-2", p2: null, type: "BAN" }, 
            { label: "P2 BAN MAP 3", p1: null, p2: "p2-banmap-2", type: "BAN" },
            { label: "PICK MAP 1", p1: "map-0", p2: null, type: "PICK_MAP" }, 
            { label: "PICK MAP 2", p1: null, p2: "map-3", type: "PICK_MAP" },
            { label: "PICK MAP 3", p1: "map-1", p2: null, type: "PICK_MAP" }, 
            { label: "PICK MAP 4", p1: null, p2: "map-4", type: "PICK_MAP" },
            { label: "DECIDER", p1: "DECIDER", p2: "DECIDER", type: "DECIDER" }, 
            { label: "FINAL", p1: null, p2: null }
        ];

        let state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [] };
        let myRole = 'host'; 
        let currentRoomCode = null; // C√≥digo da sala Firebase
        let roomRef = null; // Refer√™ncia Firebase da sala
        let isFirebaseConnected = false;
        let isUpdatingFromHost = false; // Flag para evitar loops
        let currentModalTarget = null;
        let isOfflineMode = false;
        let currentContext = 'GODS';
        
        let timerInterval = null;
        let timeLeft = 45;
        let isTransitioning = false;

        // ============ SISTEMA DE REPLAY ============
        let replayHistory = []; // Array de snapshots do estado
        let replayIndex = -1; // Posi√ß√£o atual no replay
        let isReplayMode = false; // Se est√° em modo replay
        let replayInterval = null; // Intervalo para auto-play
        let replaySpeed = 1; // Velocidade do replay
        let isRecording = false; // Se est√° gravando em tempo real
        let recordingStartTime = 0;
        let currentDraftId = null; // ID √∫nico do draft atual

        // ============ SALVAMENTO AUTOM√ÅTICO ============
        function generateDraftId() {
            return 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateRoomCode() {
            // Gera c√≥digo de 6 caracteres (ex: ABC123)
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function saveDraftToStorage() {
            if (replayHistory.length === 0) return;
            
            const draftData = {
                id: currentDraftId,
                timestamp: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                p1Name: document.getElementById('p1NameInput').value,
                p2Name: document.getElementById('p2NameInput').value,
                snapshots: replayHistory,
                totalActions: replayHistory.length
            };
            
            // Salvar draft atual
            localStorage.setItem('currentDraft', JSON.stringify(draftData));
            
            // Adicionar √† lista de drafts salvos
            let savedDrafts = JSON.parse(localStorage.getItem('savedDrafts') || '[]');
            
            // Verificar se j√° existe (atualizar)
            const existingIndex = savedDrafts.findIndex(d => d.id === currentDraftId);
            if (existingIndex >= 0) {
                savedDrafts[existingIndex] = draftData;
            } else {
                savedDrafts.push(draftData);
            }
            
            // Manter apenas os √∫ltimos 20 drafts
            if (savedDrafts.length > 20) {
                savedDrafts = savedDrafts.slice(-20);
            }
            
            localStorage.setItem('savedDrafts', JSON.stringify(savedDrafts));
            
            console.log(`‚úÖ Draft salvo: ${draftData.totalActions} a√ß√µes`);
        }

        function loadDraftFromStorage(draftId) {
            const savedDrafts = JSON.parse(localStorage.getItem('savedDrafts') || '[]');
            const draft = savedDrafts.find(d => d.id === draftId);
            
            if (!draft) {
                alert('Draft n√£o encontrado!');
                return false;
            }
            
            replayHistory = draft.snapshots;
            currentDraftId = draft.id;
            document.getElementById('p1NameInput').value = draft.p1Name;
            document.getElementById('p2NameInput').value = draft.p2Name;
            
            console.log(`üìÇ Draft carregado: ${draft.totalActions} a√ß√µes`);
            enterReplayMode();
            return true;
        }

        function loadLastDraft() {
            const currentDraft = localStorage.getItem('currentDraft');
            if (!currentDraft) return false;
            
            const draft = JSON.parse(currentDraft);
            replayHistory = draft.snapshots;
            currentDraftId = draft.id;
            document.getElementById('p1NameInput').value = draft.p1Name;
            document.getElementById('p2NameInput').value = draft.p2Name;
            
            console.log(`üìÇ √öltimo draft carregado: ${draft.totalActions} a√ß√µes`);
            return true;
        }

        function exportDraft() {
            if (replayHistory.length === 0) {
                alert('Nenhum draft para exportar!');
                return;
            }
            
            const draftData = {
                id: currentDraftId,
                timestamp: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                p1Name: document.getElementById('p1NameInput').value,
                p2Name: document.getElementById('p2NameInput').value,
                snapshots: replayHistory,
                totalActions: replayHistory.length
            };
            
            const dataStr = JSON.stringify(draftData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `draft_${draftData.p1Name}_vs_${draftData.p2Name}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Draft exportado com sucesso!');
        }

        function importDraft(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const draft = JSON.parse(e.target.result);
                    replayHistory = draft.snapshots;
                    currentDraftId = draft.id;
                    document.getElementById('p1NameInput').value = draft.p1Name;
                    document.getElementById('p2NameInput').value = draft.p2Name;
                    
                    saveDraftToStorage(); // Salvar no localStorage tamb√©m
                    enterReplayMode();
                    
                    alert(`Draft importado: ${draft.totalActions} a√ß√µes`);
                } catch (err) {
                    alert('Erro ao importar draft: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function showDraftsList() {
            const savedDrafts = JSON.parse(localStorage.getItem('savedDrafts') || '[]');
            
            if (savedDrafts.length === 0) {
                alert('Nenhum draft salvo encontrado.');
                return;
            }
            
            let html = '<div style="background: #1a1a1a; padding: 20px; border-radius: 8px; max-width: 600px; color: white;">';
            html += '<h2 style="color: #f1c40f; margin-top: 0;">üìö Drafts Salvos</h2>';
            html += '<div style="max-height: 400px; overflow-y: auto;">';
            
            savedDrafts.reverse().forEach((draft, i) => {
                html += `<div style="background: #2c3e50; padding: 15px; margin-bottom: 10px; border-radius: 4px; cursor: pointer; border: 2px solid #34495e;" onclick="loadDraftFromStorage('${draft.id}'); closeModal(event);">`;
                html += `<div style="font-weight: bold; color: #3498db;">${draft.p1Name} <span style="color: #ecf0f1;">vs</span> <span style="color: #e74c3c;">${draft.p2Name}</span></div>`;
                html += `<div style="font-size: 0.85em; color: #95a5a6; margin-top: 5px;">üìÖ ${draft.date}</div>`;
                html += `<div style="font-size: 0.85em; color: #95a5a6;">‚è±Ô∏è ${draft.totalActions} a√ß√µes</div>`;
                html += `</div>`;
            });
            
            html += '</div>';
            html += '<button onclick="closeModal(event)" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%;">Fechar</button>';
            html += '</div>';
            
            const modal = document.getElementById('selectionModal');
            document.getElementById('modalGrid').innerHTML = html;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        } 

        const params = new URLSearchParams(window.location.search);
        const roomCode = params.get('room'); // C√≥digo da sala Firebase
        const roleParam = params.get('role');
        const draftParam = params.get('draft'); // Par√¢metro do draft no URL

        // ============ FUN√á√ïES DE REPLAY ============
        
        function saveSnapshot() {
            if (!isRecording && myRole !== 'spec') return;
            
            const snapshot = {
                timestamp: Date.now(),
                state: JSON.parse(JSON.stringify(state)), // Deep clone
                p1Name: document.getElementById('p1NameInput').value,
                p2Name: document.getElementById('p2NameInput').value
            };
            
            replayHistory.push(snapshot);
            updateReplayUI();
            
            // Salvar automaticamente a cada 3 snapshots
            if (replayHistory.length % 3 === 0) {
                saveDraftToStorage();
            }
        }

        function generateShareableLink() {
            if (!currentDraftId) return null;
            
            const baseUrl = window.location.href.split('?')[0];
            return `${baseUrl}?role=spec&draft=${currentDraftId}`;
        }

        function showShareLink() {
            const link = generateShareableLink();
            if (!link) {
                alert('Nenhum draft dispon√≠vel para compartilhar.');
                return;
            }
            
            // Copiar para clipboard
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copiado! Compartilhe para que outros vejam o replay:\n\n' + link);
            }).catch(() => {
                prompt('Copie este link para compartilhar:', link);
            });
        }

        function toggleRecord() {
            isRecording = !isRecording;
            const btn = document.getElementById('btnRecord');
            
            if (isRecording) {
                btn.classList.add('recording');
                btn.innerHTML = '‚èπÔ∏è Parar';
                replayHistory = []; // Limpar hist√≥rico anterior
                currentDraftId = generateDraftId(); // Novo ID
                recordingStartTime = Date.now();
                saveSnapshot(); // Salvar estado inicial
            } else {
                btn.classList.remove('recording');
                btn.innerHTML = '‚è∫Ô∏è Gravar';
                if (replayHistory.length > 0) {
                    saveDraftToStorage(); // Salvar ao parar
                    alert(`Grava√ß√£o finalizada! ${replayHistory.length} snapshots capturados e salvos.`);
                }
            }
        }

        function enterReplayMode() {
            if (replayHistory.length === 0) return;
            
            isReplayMode = true;
            replayIndex = 0;
            loadReplaySnapshot(0);
            updateReplayUI();
        }

        function exitReplayMode() {
            isReplayMode = false;
            stopReplayPlay();
            replayIndex = -1;
            updateReplayUI();
        }

        function loadReplaySnapshot(index) {
            if (index < 0 || index >= replayHistory.length) return;
            
            const snapshot = replayHistory[index];
            state = JSON.parse(JSON.stringify(snapshot.state)); // Deep clone
            document.getElementById('p1NameInput').value = snapshot.p1Name;
            document.getElementById('p2NameInput').value = snapshot.p2Name;
            
            // Limpar e recriar logs
            document.getElementById('logContainer').innerHTML = '';
            
            replayIndex = index;
            render();
            updateReplayUI();
        }

        function replayRewind() {
            if (replayHistory.length === 0) {
                alert('Nenhuma grava√ß√£o dispon√≠vel. Clique em "Gravar" durante um draft.');
                return;
            }
            
            stopReplayPlay();
            if (!isReplayMode) enterReplayMode();
            loadReplaySnapshot(0);
        }

        function replayStepBack() {
            if (!isReplayMode || replayIndex <= 0) return;
            stopReplayPlay();
            loadReplaySnapshot(replayIndex - 1);
        }

        function replayStepForward() {
            if (!isReplayMode || replayIndex >= replayHistory.length - 1) return;
            stopReplayPlay();
            loadReplaySnapshot(replayIndex + 1);
        }

        function replayTogglePlay() {
            if (replayHistory.length === 0) {
                alert('Nenhuma grava√ß√£o dispon√≠vel. Clique em "Gravar" durante um draft.');
                return;
            }

            if (!isReplayMode) enterReplayMode();
            
            const btn = document.getElementById('btnPlayPause');
            
            if (replayInterval) {
                stopReplayPlay();
            } else {
                startReplayPlay();
            }
        }

        function startReplayPlay() {
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = '‚è∏Ô∏è Pausar';
            btn.classList.add('playing');
            
            const baseInterval = 1000; // 1 segundo entre snapshots
            const interval = baseInterval / replaySpeed;
            
            replayInterval = setInterval(() => {
                if (replayIndex >= replayHistory.length - 1) {
                    stopReplayPlay();
                    return;
                }
                loadReplaySnapshot(replayIndex + 1);
            }, interval);
        }

        function stopReplayPlay() {
            if (replayInterval) {
                clearInterval(replayInterval);
                replayInterval = null;
            }
            
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = '‚ñ∂Ô∏è Play';
            btn.classList.remove('playing');
        }

        function updateReplaySpeed() {
            replaySpeed = parseFloat(document.getElementById('replaySpeed').value);
            
            if (replayInterval) {
                stopReplayPlay();
                startReplayPlay();
            }
        }

        function seekReplay(event) {
            if (replayHistory.length === 0) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percent = x / rect.width;
            const targetIndex = Math.floor(percent * replayHistory.length);
            
            stopReplayPlay();
            if (!isReplayMode) enterReplayMode();
            loadReplaySnapshot(Math.max(0, Math.min(targetIndex, replayHistory.length - 1)));
        }

        function updateReplayUI() {
            if (myRole !== 'spec') return;
            
            const progressBar = document.getElementById('replayProgressBar');
            const timeDisplay = document.getElementById('replayTime');
            
            if (replayHistory.length > 0 && isReplayMode) {
                const percent = (replayIndex / (replayHistory.length - 1)) * 100;
                progressBar.style.width = percent + '%';
                timeDisplay.innerText = `${replayIndex + 1} / ${replayHistory.length}`;
            } else {
                progressBar.style.width = '0%';
                timeDisplay.innerText = `0 / ${replayHistory.length}`;
            }
        }

        function init() {
            if (!roomCode) {
                myRole = 'host'; 
                document.getElementById('hostPanel').style.display = 'block'; 
                render(); 
                setupHost();
            } else {
                myRole = roleParam || 'spec'; 
                
                // Se tem par√¢metro draft, carregar do localStorage
                if (draftParam && myRole === 'spec') {
                    if (loadDraftFromStorage(draftParam)) {
                        document.getElementById('specBanner').style.display='block';
                        document.getElementById('replayControls').classList.add('active');
                        document.body.classList.add('spectator-mode');
                        console.log('üìÇ Draft carregado do URL');
                        return; // N√£o conectar ao Firebase
                    }
                }
                
                setupClient(roomCode); 
                
                if(myRole==='spec') {
                    document.getElementById('specBanner').style.display='block';
                    document.getElementById('replayControls').classList.add('active');
                    // ATIVA MODO ESPECTADOR PARA ANIMA√á√ïES √âPICAS
                    document.body.classList.add('spectator-mode');
                    
                    // Iniciar grava√ß√£o autom√°tica
                    isRecording = true;
                    currentDraftId = generateDraftId();
                    
                    // Tentar carregar √∫ltimo draft se existir
                    if (loadLastDraft()) {
                        enterReplayMode();
                        console.log('üìÇ √öltimo draft carregado automaticamente');
                    }
                }
            }
            render();
        }

        // ============ TIMER LOGIC ============
        function startTimer() {
            clearInterval(timerInterval); 
            timeLeft = 45; 
            
            const el = document.getElementById('timerDisplay');
            el.innerText = "45";
            el.classList.remove('timer-urgent');
            el.classList.add('timer-resetting');
            setTimeout(() => el.classList.remove('timer-resetting'), 500);
            
            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase || currentPhase.type.includes("REVEAL") || currentPhase.type === "DECIDER" || state.phaseIndex >= 27) {
                el.style.display = 'none';
                return;
            }
            
            el.style.display = 'block';
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const el = document.getElementById('timerDisplay');
            el.innerText = timeLeft;
            if (timeLeft <= 10) el.classList.add('timer-urgent'); 
            else el.classList.remove('timer-urgent');
        }

        function handleTimeout() {
            if (isTransitioning) return; 

            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase) return;

            if (isOfflineMode) {
                const p1Data = (currentPhase.p1 && !state.p1Ready) ? getRandomFor(currentPhase.p1) : null;
                const p2Data = (currentPhase.p2 && !state.p2Ready) ? getRandomFor(currentPhase.p2, (p1Data ? [p1Data.n] : [])) : null;

                if(p1Data) state.selections[currentPhase.p1] = { ...p1Data, isRandom: true };
                if(p2Data) state.selections[currentPhase.p2] = { ...p2Data, isRandom: true };

                if (currentPhase.p1) state.p1Ready = true;
                if (currentPhase.p2) state.p2Ready = true;

                checkPhaseAdvance();
                render();
            } 
            else {
                if (myRole === 'host') {
                    const p1Data = (currentPhase.p1 && !state.p1Ready) ? getRandomFor(currentPhase.p1) : null;
                    const p2Data = (currentPhase.p2 && !state.p2Ready) ? getRandomFor(currentPhase.p2, (p1Data ? [p1Data.n] : [])) : null;
                    
                    if(p1Data) processHostAction({ action: 'SELECT_RANDOM', payload: { slot: currentPhase.p1, data: p1Data } });
                    if(p2Data) processHostAction({ action: 'SELECT_RANDOM', payload: { slot: currentPhase.p2, data: p2Data } });
                }
                else if (myRole === 'p2') {
                     if (currentPhase.p2 && !state.p2Ready) {
                         const d = getRandomFor(currentPhase.p2);
                         if(d) sendAction('SELECT_RANDOM', { slot: currentPhase.p2, data: d });
                     }
                }
            }
        }

        function getRandomFor(slotId, tempExclusions = []) {
            if (!slotId) return null;
            let type = slotId.includes('god') ? 'god' : 'map';
            let activePlayer = slotId.startsWith('p1') ? 'p1' : (slotId.startsWith('p2') ? 'p2' : null);
            if(!activePlayer) { 
                 const ph = TIMELINE[state.phaseIndex];
                 if(ph.p1 === slotId) activePlayer = 'p1'; 
                 else if(ph.p2 === slotId) activePlayer = 'p2';
            }

            const list = (type === 'map' || type === 'banmap') ? mapsData : godsData;
            let bannedNames = [...tempExclusions];
            let myUsedNames = [];
            let globalUsedMaps = [];
            let opponentPickedGods = [];
            const opponentPrefix = (activePlayer === 'p1') ? 'p2-' : 'p1-';

            if (state.selections) {
                Object.keys(state.selections).forEach(key => {
                    const item = state.selections[key];
                    if (!item) return;
                    if (key.includes('ban')) bannedNames.push(item.n);
                    else {
                        if (key.includes('god')) {
                            if (key.startsWith(opponentPrefix)) opponentPickedGods.push(item.n);
                            if (key.startsWith(activePlayer + '-god-')) myUsedNames.push(item.n);
                        }
                        if (key.startsWith('map-')) globalUsedMaps.push(item.n);
                    }
                });
            }

            let validItems = list.filter(d => {
                if (bannedNames.includes(d.n)) return false;
                if (slotId.includes('ban') && opponentPickedGods.includes(d.n)) return false; 
                if (type === 'map' && globalUsedMaps.includes(d.n)) return false;
                if (type === 'god' && !slotId.includes('ban') && myUsedNames.includes(d.n)) return false;
                return true;
            });

            if (validItems.length > 0) return validItems[Math.floor(Math.random() * validItems.length)];
            return null;
        }

        function addLogEntry(player, type, itemName, isRandom) {
            const pName = player === 'p1' ? document.getElementById('p1NameInput').value : document.getElementById('p2NameInput').value;
            const logEntry = { player: player, name: pName, action: type === 'ban' ? 'baniu' : 'escolheu', item: itemName, isRandom: isRandom };
            state.logs.push(logEntry);
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            
            // Garantir que logs existe
            if (!state.logs) {
                state.logs = [];
                return;
            }
            
            // CORRE√á√ÉO: S√≥ adicionar novos logs, n√£o recriar tudo
            const currentLogCount = container.querySelectorAll('.log-entry').length;
            const newLogs = state.logs.slice(currentLogCount);
            
            newLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                let playerClass = log.player === 'p1' ? 'p1' : 'p2';
                let randomText = log.isRandom ? " <span class='random'>(Aleat√≥rio ‚ùì)</span>" : "";
                entry.innerHTML = `<span class="${playerClass}">${log.name}</span> ${log.action} <strong>${log.item}</strong>${randomText}`;
                container.appendChild(entry);
            });
            
            setTimeout(() => container.scrollTop = container.scrollHeight, 10);
        }

        function toggleReady(player) {
            let allowed = false;
            
            // HOST pode confirmar P1, P2 s√≥ pode confirmar P2
            if (myRole === 'host' && player === 'p1') allowed = true;
            if (myRole === 'p2' && player === 'p2') allowed = true;

            if (allowed) {
                console.log(`üéÆ ${myRole} confirmando ${player}`);
                sendAction('TOGGLE_READY', { player: player });
            } else {
                console.log(`‚õî ${myRole} tentou confirmar ${player} - bloqueado`);
            }
        }

        function checkReadyStart() {
            console.log('üîç Verificando ready:', { p1: state.p1Presence, p2: state.p2Presence });
            
            if (state.p1Presence && state.p2Presence) {
                console.log('‚úÖ Ambos prontos! Iniciando draft...');
                
                // Apenas o HOST inicia o draft e faz broadcast
                if (myRole === 'host') {
                    setTimeout(() => {
                        state.phaseIndex = 0;
                        broadcastState();
                        startTimer();
                    }, 500);
                } else {
                    // P2 apenas renderiza a tela de espera
                    render();
                }
            }
        }

        function renderTimeline() {
            if (state.phaseIndex === -1) return;
            const tlState = getTimelineState(state.phaseIndex);
            
            if (currentContext !== tlState.context || document.getElementById('timelineSteps').children.length === 0) {
                currentContext = tlState.context;
                const container = document.getElementById('timelineSteps');
                container.innerHTML = '';
                const blocks = (currentContext === 'GODS') ? GOD_BLOCKS : MAP_BLOCKS;
                blocks.forEach((block, i) => {
                    const el = document.createElement('div');
                    el.className = 't-pill';
                    el.innerText = block.label;
                    el.setAttribute('data-type', block.type);
                    el.id = `tpill-${i}`;
                    container.appendChild(el);
                });
            }
            const total = (currentContext === 'GODS') ? GOD_BLOCKS.length : MAP_BLOCKS.length;
            for(let i=0; i<total; i++) {
                const el = document.getElementById(`tpill-${i}`);
                if(!el) continue;
                el.className = 't-pill'; 
                if (i < tlState.index) el.classList.add('done');
                else if (i === tlState.index) el.classList.add('active');
            }
        }

        function sendAction(actionType, payload) {
            const msg = { type: 'ACTION', action: actionType, payload: payload, role: myRole };
            // Com Firebase, sempre processar localmente e deixar o Firebase sincronizar
            processHostAction(msg);
        }

        function processHostAction(msg) {
            if (msg.action === 'SELECT') {
                state.selections[msg.payload.slot] = msg.payload.data;
            } 
            else if (msg.action === 'SELECT_RANDOM') {
                state.selections[msg.payload.slot] = { ...msg.payload.data, isRandom: true };
                let current = TIMELINE[state.phaseIndex];
                if (current.p1 === msg.payload.slot) state.p1Ready = true;
                if (current.p2 === msg.payload.slot) state.p2Ready = true;
                checkPhaseAdvance();
            }
            else if (msg.action === 'CONFIRM') {
                if (msg.role === 'host' || msg.role === 'p1') state.p1Ready = true;
                if (msg.role === 'p2') state.p2Ready = true;
                checkPhaseAdvance();
            }
            else if (msg.action === 'TOGGLE_READY') {
                if (msg.payload.player === 'p1') state.p1Presence = !state.p1Presence;
                if (msg.payload.player === 'p2') state.p2Presence = !state.p2Presence;
                checkReadyStart();
            }
            else if (msg.action === 'RESET') {
                state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [] };
                // Limpar container de logs
                document.getElementById('logContainer').innerHTML = '';
            }
            
            // CORRE√á√ÉO: Qualquer um pode atualizar Firebase (n√£o s√≥ host)
            if (roomRef && isFirebaseConnected) {
                roomRef.update({
                    state: state,
                    p1Name: document.getElementById('p1NameInput').value,
                    p2Name: document.getElementById('p2NameInput').value,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    console.log('‚úÖ Estado sincronizado no Firebase por', myRole);
                }).catch((error) => {
                    console.error('‚ùå Erro ao sincronizar:', error);
                });
            }
            
            render();
        }

        function broadcastState() {
            render();
            saveSnapshot();
            
            if (myRole === 'host' && roomRef && isFirebaseConnected) {
                isUpdatingFromHost = true;
                
                roomRef.update({
                    state: state,
                    p1Name: document.getElementById('p1NameInput').value,
                    p2Name: document.getElementById('p2NameInput').value,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    console.log('‚úÖ Estado sincronizado no Firebase');
                    setTimeout(() => { isUpdatingFromHost = false; }, 100);
                }).catch((error) => {
                    console.error('‚ùå Erro ao sincronizar:', error);
                    isUpdatingFromHost = false;
                });
            }
        }

        function clickSlot(player, type, index) {
            if (state.phaseIndex === -1) return; 
            let slotId = (player === 'map') ? `map-${index}` : `${player}-${type}-${index}`;
            if (myRole === 'spec') return;
            const currentPhase = TIMELINE[state.phaseIndex];
            if (!currentPhase || currentPhase.type.includes("REVEAL") || currentPhase.type === "DECIDER") return;

            let owner = null;
            if (slotId === currentPhase.p1) owner = 'p1';
            if (slotId === currentPhase.p2) owner = 'p2';
            if (!owner) return;

            let hasPermission = false;
            if (isOfflineMode) hasPermission = true; 
            else {
                if (myRole === 'host' && owner === 'p1') hasPermission = true;
                if (myRole === 'p2' && owner === 'p2') hasPermission = true;
                if (myRole === 'host' && owner === 'p2' && connections.length === 0) hasPermission = true;
            }

            if (owner === 'p1' && state.p1Ready) hasPermission = false;
            if (owner === 'p2' && state.p2Ready) hasPermission = false;

            if (hasPermission) openModal(slotId, type, owner);
        }

        function openModal(slotId, type, activePlayer) {
            currentModalTarget = slotId;
            const grid = document.getElementById('modalGrid'); 
            grid.innerHTML = '';
            const list = (type === 'map' || type === 'banmap') ? mapsData : godsData;
            
            let bannedNames = [];
            let myUsedNames = [];
            let globalUsedMaps = [];
            const opponentPrefix = (activePlayer === 'p1') ? 'p2-' : 'p1-';
            let opponentPickedGods = [];

            if (state.selections) {
                Object.keys(state.selections).forEach(key => {
                    const item = state.selections[key];
                    if (!item) return;
                    if (key.includes('ban')) bannedNames.push(item.n);
                    else {
                        if (key.includes('god')) {
                            if (key.startsWith(opponentPrefix)) opponentPickedGods.push(item.n);
                            if (key.startsWith(activePlayer + '-god-')) myUsedNames.push(item.n);
                        }
                        if (key.startsWith('map-')) globalUsedMaps.push(item.n);
                    }
                });
            }

            list.forEach(d => {
                const c = document.createElement('div'); 
                c.className = 'selectable-card';
                if (type.includes('map')) c.classList.add('is-map-card');

                let disabled = false;
                if (bannedNames.includes(d.n)) { disabled = true; c.classList.add('banned-overlay'); }
                if (type === 'bangod' && opponentPickedGods.includes(d.n)) { disabled = true; c.classList.add('protected-overlay'); }
                if (type.includes('map') && globalUsedMaps.includes(d.n)) { disabled = true; c.classList.add('picked-overlay'); }
                if (type === 'god' && myUsedNames.includes(d.n)) { disabled = true; c.classList.add('picked-overlay'); }

                if (disabled) c.classList.add('card-disabled');
                c.innerHTML = `<img src="${d.img}" onerror="this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'"><div class="card-name-overlay">${d.n}</div>`;
                if (!disabled) c.onclick = () => selectItem(d);
                grid.appendChild(c);
            });
            const modal = document.getElementById('selectionModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function selectItem(data) {
            closeModal();
            if (myRole === 'host') {
                // Host: processar localmente e Firebase sincroniza
                state.selections[currentModalTarget] = data;
                render();
                let currentPhase = TIMELINE[state.phaseIndex];
                let p1Need = currentPhase.p1 && !state.p1Ready;
                let p2Need = currentPhase.p2 && !state.p2Ready;
                if(p1Need || p2Need) document.getElementById('confirmBtn').style.display = 'block';
            } else {
                // P2: enviar a√ß√£o que ser√° processada e sincronizada
                sendAction('SELECT', { slot: currentModalTarget, data: data });
            }
        }

        function confirmTurn() {
            document.getElementById('confirmBtn').style.display = 'none';
            if (myRole === 'host') {
                let currentPhase = TIMELINE[state.phaseIndex];
                if(currentPhase.p1) state.p1Ready = true;
                if(currentPhase.p2) state.p2Ready = true;
                checkPhaseAdvance();
                render();
                saveSnapshot();
            } else {
                sendAction('CONFIRM', null);
            }
        }

        function checkPhaseAdvance() {
            let currentPhase = TIMELINE[state.phaseIndex];
            let p1OK = !currentPhase.p1 || state.p1Ready;
            let p2OK = !currentPhase.p2 || state.p2Ready;

            if (p1OK && p2OK) {
                clearInterval(timerInterval); 
                isTransitioning = true; 
                document.getElementById('timerDisplay').innerText = "--";

                if (currentPhase.p1 && state.selections[currentPhase.p1]) {
                    const item = state.selections[currentPhase.p1];
                    addLogEntry('p1', (currentPhase.p1.includes('ban') ? 'ban' : 'pick'), item.n, item.isRandom || false);
                }
                if (currentPhase.p2 && state.selections[currentPhase.p2]) {
                    const item = state.selections[currentPhase.p2];
                    addLogEntry('p2', (currentPhase.p2.includes('ban') ? 'ban' : 'pick'), item.n, item.isRandom || false);
                }
                
                renderLogs();

                setTimeout(() => {
                    state.phaseIndex++;
                    state.p1Ready = false; 
                    state.p2Ready = false;
                    isTransitioning = false;
                    
                    if (TIMELINE[state.phaseIndex].type === "REVEAL_STEP") {
                        if(isOfflineMode) render(); 
                        else broadcastState();
                        setTimeout(() => {
                            state.phaseIndex++;
                            if(isOfflineMode) { render(); startTimer(); } 
                            else { broadcastState(); if(myRole==='host') startTimer(); } 
                        }, 3000);
                        return; 
                    }

                    if (TIMELINE[state.phaseIndex].type === "DECIDER") autoPickDecider();
                    
                    // Verificar se draft terminou
                    if (state.phaseIndex >= TIMELINE.length - 1) {
                        saveDraftToStorage(); // Salvar draft completo
                        console.log('‚úÖ Draft finalizado e salvo!');
                        
                        // Se √© host, mostrar link para compartilhar
                        if (myRole === 'host' && currentDraftId) {
                            setTimeout(() => {
                                const shareLink = generateShareableLink();
                                if (shareLink) {
                                    if (confirm('Draft finalizado! Deseja copiar o link de replay para compartilhar?')) {
                                        navigator.clipboard.writeText(shareLink).then(() => {
                                            alert('‚úÖ Link copiado! Compartilhe para que outros vejam o replay:\n\n' + shareLink);
                                        }).catch(() => {
                                            prompt('Copie este link para compartilhar o replay:', shareLink);
                                        });
                                    }
                                }
                            }, 2000);
                        }
                    }
                    
                    if(isOfflineMode) { render(); startTimer(); } 
                    else { broadcastState(); if(myRole==='host') startTimer(); }
                }, 500);
            }
        }

        function autoPickDecider() {
            let forbidden = [];
            if (state.selections) {
                Object.values(state.selections).forEach(s => forbidden.push(s.n));
            }
            let available = mapsData.filter(m => !forbidden.includes(m.n));
            if (available.length > 0) {
                let picked = available[Math.floor(Math.random() * available.length)];
                state.selections['map-2'] = picked;
                setTimeout(() => { 
                    state.phaseIndex++; 
                    if(isOfflineMode) { render(); } 
                    else { broadcastState(); }
                }, 1500);
            }
        }

        function render() {
            const overlay = document.getElementById('readyOverlay');
            if (state.phaseIndex === -1) {
                overlay.style.display = 'flex'; 
                overlay.style.opacity = '1';
                const box1 = document.getElementById('p1ReadyBox');
                const btn1 = document.getElementById('btnReadyP1');
                if (state.p1Presence) { box1.classList.add('ready'); btn1.innerText = "PRONTO"; } 
                else { box1.classList.remove('ready'); btn1.innerText = "CONFIRMAR"; }
                const box2 = document.getElementById('p2ReadyBox');
                const btn2 = document.getElementById('btnReadyP2');
                if (state.p2Presence) { box2.classList.add('ready'); btn2.innerText = "PRONTO"; } 
                else { box2.classList.remove('ready'); btn2.innerText = "CONFIRMAR"; }
                return; 
            } else {
                overlay.style.opacity = '0'; 
                setTimeout(() => overlay.style.display = 'none', 500);
            }

            // Atualizar nomes nos grupos de gods (para mobile)
            const p1Group = document.querySelector('.god-group.p1-group');
            const p2Group = document.querySelector('.god-group.p2-group');
            if (p1Group) p1Group.setAttribute('data-player-name', document.getElementById('p1NameInput').value);
            if (p2Group) p2Group.setAttribute('data-player-name', document.getElementById('p2NameInput').value);

            renderTimeline();
            renderLogs(); 

            const currentPhase = TIMELINE[state.phaseIndex];
            
            if(currentPhase && !currentPhase.type.includes("REVEAL") && currentPhase.type !== "DECIDER") {
                let show = false;
                if(isOfflineMode || (myRole === 'host' && connections.length === 0)) {
                    if((currentPhase.p1 && !state.p1Ready) || (currentPhase.p2 && !state.p2Ready)) show = true;
                } else {
                    if(myRole === 'host' && currentPhase.p1 && !state.p1Ready && state.selections[currentPhase.p1]) show = true;
                    if(myRole === 'p2' && currentPhase.p2 && !state.p2Ready && state.selections[currentPhase.p2]) show = true;
                }
                document.getElementById('confirmBtn').style.display = show ? 'block' : 'none';
            } else { 
                document.getElementById('confirmBtn').style.display = 'none'; 
            }

            const allSlots = document.querySelectorAll('.god-slot, .ban-slot, .map-slot');
            
            allSlots.forEach(el => {
                const id = el.id;
                const data = state.selections[id];
                el.classList.remove('slot-active', 'slot-locked', 'slot-pending-confirm', 'slot-blind-ready');
                
                // CORRE√á√ÉO CR√çTICA: Para bans, s√≥ atualizar se estiver vazio
                if (id.includes('ban')) {
                    if (!data) {
                        el.innerHTML = '';
                        el.classList.remove('filled');
                    } else if (!el.classList.contains('filled')) {
                        // Primeira vez preenchendo - criar HTML
                        let randomMark = data.isRandom ? `<div class="random-mark">‚ùì</div>` : '';
                        el.innerHTML = `<img src="${data.img}" onerror="this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'">` + randomMark;
                        el.classList.add('filled');
                        
                        // Adicionar classe 'animated' ap√≥s anima√ß√£o
                        const img = el.querySelector('img');
                        if (img) {
                            setTimeout(() => {
                                img.classList.add('animated');
                            }, 500);
                        }
                    }
                    // Se j√° est√° filled, N√ÉO fazer nada (mant√©m estado)
                } 
                // CORRE√á√ÉO: Mesma l√≥gica para MAPAS - evitar re-anima√ß√£o
                else if (id.includes('map')) {
                    if (!data) {
                        el.innerHTML = '';
                        el.classList.remove('filled');
                    } else if (!el.classList.contains('filled')) {
                        // Primeira vez preenchendo
                        let randomMark = data.isRandom ? `<div class="random-mark">‚ùì</div>` : '';
                        let htmlContent = `<img src="${data.img}" onerror="this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'">` + randomMark;
                        htmlContent += `<div class="map-name-label">${data.n}</div>`;
                        el.innerHTML = htmlContent;
                        el.classList.add('filled');
                    }
                    // Se j√° est√° filled, N√ÉO fazer nada
                }
                else {
                    // L√≥gica normal para gods (que precisam de blind pick logic)
                    if (!data) el.innerHTML = ''; 
                    else if (!el.querySelector('img')) el.innerHTML = '';

                    if (data) {
                    let hideMe = false;
                    if (currentPhase && currentPhase.type === "BLIND_PICK" && (id === currentPhase.p1 || id === currentPhase.p2)) {
                        if(isOfflineMode) { 
                            if ((id === currentPhase.p1 && state.p1Ready) || (id === currentPhase.p2 && state.p2Ready)) hideMe = true; 
                        } 
                        else { 
                            if(myRole === 'host' && connections.length === 0) { 
                                if((id===currentPhase.p1 && state.p1Ready) || (id===currentPhase.p2 && state.p2Ready)) hideMe = true; 
                            } else {
                                if (myRole === 'host' && id === currentPhase.p2) hideMe = true; 
                                if (myRole === 'p2' && id === currentPhase.p1) hideMe = true; 
                                if (myRole === 'spec') hideMe = true; 
                            }
                        }
                    }

                    if (hideMe) { 
                        el.classList.add('slot-blind-ready'); 
                        el.innerHTML = ''; 
                    }
                    else {
                        let htmlContent = '';
                        let randomMark = data.isRandom ? `<div class="random-mark">‚ùì</div>` : '';
                        htmlContent = `<img src="${data.img}" onerror="this.style.display='none'; this.parentNode.innerHTML+='<span style=\\'color:red;font-size:0.7em\\'>IMG ERR</span>'">` + randomMark;
                        
                        if (el.innerHTML !== htmlContent) {
                            el.innerHTML = htmlContent;
                        }
                    }
                } else el.classList.remove('filled');
                } // Fecha o else da l√≥gica de gods

                if (!currentPhase) return;

                let isActive = false;
                if (id === currentPhase.p1 || id === currentPhase.p2) isActive = true;

                if (isActive) {
                    el.classList.add('slot-active');
                    let pending = false;
                    if(data) {
                        if(isOfflineMode || (myRole === 'host' && connections.length === 0)) { 
                            if ((id === currentPhase.p1 && !state.p1Ready) || (id === currentPhase.p2 && !state.p2Ready)) pending = true; 
                        }
                        else { 
                            if ((myRole==='host' && id===currentPhase.p1 && !state.p1Ready) || (myRole==='p2' && id===currentPhase.p2 && !state.p2Ready)) pending = true; 
                        }
                    }
                    if (pending) el.classList.add('slot-pending-confirm');
                } else if (data) el.classList.add('slot-locked');
            });
        }

        function setupHost() {
            myRole = 'host';
            currentRoomCode = generateRoomCode();
            
            console.log('üî• Criando sala Firebase:', currentRoomCode);
            
            // Criar refer√™ncia da sala
            roomRef = db.ref('rooms/' + currentRoomCode);
            
            // Salvar estado inicial
            roomRef.set({
                state: state,
                p1Name: document.getElementById('p1NameInput').value,
                p2Name: document.getElementById('p2NameInput').value,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log('‚úÖ Sala criada com sucesso!');
                isFirebaseConnected = true;
                
                // Aguardar um pouco antes de ativar listener para n√£o pegar a pr√≥pria cria√ß√£o
                setTimeout(() => {
                    // Escutar mudan√ßas (para sincronizar a√ß√µes de outros jogadores)
                    console.log('üëÇ HOST: Iniciando listener de atualiza√ß√µes...');
                    roomRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && !isUpdatingFromHost) {
                            console.log('üì• HOST recebeu atualiza√ß√£o do Firebase!');
                            
                            const oldP1Presence = state.p1Presence;
                            const oldP2Presence = state.p2Presence;
                            
                            // Atualizar estado local com dados do Firebase
                            state = data.state;
                            
                            // Garantir que selections sempre existe
                            if (!state.selections) state.selections = {};
                            if (!state.logs) state.logs = [];
                            
                            console.log('   phaseIndex:', state.phaseIndex, 'p1:', state.p1Presence, 'p2:', state.p2Presence);
                            
                            render();
                            
                            // Verificar se precisa iniciar draft
                            if (state.phaseIndex === -1 && (oldP1Presence !== state.p1Presence || oldP2Presence !== state.p2Presence)) {
                                console.log('üîî Status de ready mudou no HOST, verificando...');
                                checkReadyStart();
                            }
                        }
                    });
                }, 1000);
            }).catch((error) => {
                console.error('‚ùå Erro ao criar sala:', error);
                alert('Erro ao criar sala Firebase. Verifique sua conex√£o com a internet.');
            });
            
            // Atualizar links na interface
            const baseUrl = window.location.href.split('?')[0];
            document.getElementById('linkP2').value = `${baseUrl}?room=${currentRoomCode}&role=p2`;
            document.getElementById('linkSpec').value = `${baseUrl}?room=${currentRoomCode}&role=spec`;
            
            console.log('üéØ C√≥digo da sala:', currentRoomCode);
        }

        function setupClient(roomCode) {
            currentRoomCode = roomCode;
            
            console.log('üî• Conectando √† sala Firebase:', roomCode);
            
            // Criar refer√™ncia da sala
            roomRef = db.ref('rooms/' + roomCode);
            
            // Verificar se sala existe
            roomRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('‚ùå Sala n√£o encontrada!\n\nVerifique se:\n1. O c√≥digo est√° correto\n2. O host ainda est√° conectado');
                    return;
                }
                
                console.log('‚úÖ Sala encontrada!');
                isFirebaseConnected = true;
                
                // Carregar estado inicial
                const data = snapshot.val();
                console.log('üì¶ Dados iniciais:', data);
                state = data.state;
                
                // Garantir que selections sempre existe
                if (!state.selections) state.selections = {};
                if (!state.logs) state.logs = [];
                
                document.getElementById('p1NameInput').value = data.p1Name;
                document.getElementById('p2NameInput').value = data.p2Name;
                
                render();
                saveSnapshot();
                
                // Escutar atualiza√ß√µes em tempo real
                console.log('üëÇ Iniciando listener de atualiza√ß√µes...');
                roomRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        console.log('üì• Atualiza√ß√£o recebida do Firebase!');
                        
                        const oldPhase = state.phaseIndex;
                        const oldP1Presence = state.p1Presence;
                        const oldP2Presence = state.p2Presence;
                        
                        state = data.state;
                        
                        // Garantir que selections sempre existe
                        if (!state.selections) state.selections = {};
                        if (!state.logs) state.logs = [];
                        
                        console.log('   phaseIndex:', state.phaseIndex, 'p1:', state.p1Presence, 'p2:', state.p2Presence);
                        
                        document.getElementById('p1NameInput').value = data.p1Name;
                        document.getElementById('p2NameInput').value = data.p2Name;
                        
                        render();
                        saveSnapshot();
                        
                        // Verificar se precisa iniciar draft
                        if (state.phaseIndex === -1 && (oldP1Presence !== state.p1Presence || oldP2Presence !== state.p2Presence)) {
                            console.log('üîî Status de ready mudou, verificando...');
                            checkReadyStart();
                        }
                        
                        if (state.phaseIndex !== oldPhase && state.phaseIndex < 27) {
                            startTimer();
                        }
                    }
                });
                
            }).catch((error) => {
                console.error('‚ùå Erro ao conectar:', error);
                alert('Erro ao conectar √† sala. Verifique sua conex√£o com a internet.');
            });
        }
        
        function copyLink(id, btnElement) { 
            const i = document.getElementById(id); 
            i.select(); 
            document.execCommand('copy'); 
            
            const originalText = btnElement.innerText;
            btnElement.innerText = "SUCESSO!";
            btnElement.style.background = "#2ecc71";
            btnElement.style.color = "#000";
            
            setTimeout(() => {
                btnElement.innerText = originalText;
                btnElement.style.background = "";
                btnElement.style.color = "";
            }, 2000);
        }

        function closeModal(e) { 
            if(e && e.target !== document.getElementById('selectionModal')) return; 
            document.getElementById('selectionModal').classList.remove('show'); 
            setTimeout(()=>document.getElementById('selectionModal').style.display='none', 300); 
        }
        
        function resetDraft() { 
            if(confirm("Reset?")) { 
                if(isOfflineMode) { 
                    state = { phaseIndex: -1, p1Ready: false, p2Ready: false, p1Presence: false, p2Presence: false, selections: {}, logs: [] }; 
                    document.getElementById('logContainer').innerHTML = '';
                    render(); 
                } else sendAction('RESET', null); 
            } 
        }

        init();
    </script>
</body>
</html>
