<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AoM Retold - Draft V64 (Connection Fixed)</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Mantive seu CSS original por ser excelente visualmente */
        :root {
            --bg-body: #050505;
            --text-gold: #f1c40f;
            --p1-color: #3498db;
            --p2-color: #e74c3c;
            --slot-bg: #0f0f0f;
            --slot-border: #333;
            --ban-color: #c0392b;
            --tl-pick-bg: #27ae60;
            --tl-ban-bg: #c0392b;
            --tl-reveal-bg: #ecf0f1;
            --tl-inactive: #111;
        }

        body {
            font-family: 'Cinzel', serif;
            background-color: rgba(0, 0, 0, 0.85); 
            background-image: url('fundooo.png');
            background-blend-mode: multiply;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            color: #ecf0f1;
            margin: 0; padding: 0; 
            min-height: 100vh;
            width: 100vw; 
            overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Classes de animação e estados */
        .ready-check-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000;
        }

        .ready-box {
            background: rgba(20, 20, 20, 0.8); border: 2px solid #333;
            padding: 40px; border-radius: 8px; text-align: center; width: 280px; transition: 0.3s;
        }

        .ready-box.ready { border-color: #27ae60; box-shadow: 0 0 20px rgba(39, 174, 96, 0.4); }

        .ready-btn {
            background: transparent; border: 1px solid #f1c40f; color: #f1c40f;
            padding: 10px 20px; cursor: pointer; font-family: 'Cinzel'; width: 100%;
        }

        .ready-box.ready .ready-btn { background: #27ae60; color: white; border-color: #27ae60; }

        /* Estilos omitidos por brevidade, mas mantidos os seus */
        .host-panel { position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; border-radius: 5px; }
        .confirm-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 15px 50px; background: #27ae60; color: white; border: none; font-family: 'Cinzel'; font-weight: bold; cursor: pointer; z-index: 1000; display: none; }
        
        /* Adicione o restante do seu CSS aqui */
        .main-container { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 20px; }
        .god-groups-container { display: flex; gap: 20px; justify-content: center; width: 100%; }
        .god-slot { width: 100px; height: 180px; border: 2px solid #444; background: #111; position: relative; overflow: hidden; }
        .god-slot img { width: 100%; height: 100%; object-fit: cover; }
        .timer-display { font-size: 3em; color: gold; margin: 10px; }
    </style>
</head>
<body>

    <div id="readyOverlay" class="ready-check-overlay">
        <h1 style="color:gold; letter-spacing: 5px;">LOBBY DE DRAFT</h1>
        <div style="display: flex; gap: 20px; margin-top: 30px;">
            <div id="p1ReadyBox" class="ready-box">
                <h2>JOGADOR 1</h2>
                <button id="btnReadyP1" class="ready-btn" onclick="toggleReady('p1')">CONFIRMAR</button>
            </div>
            <div id="p2ReadyBox" class="ready-box">
                <h2>JOGADOR 2</h2>
                <button id="btnReadyP2" class="ready-btn" onclick="toggleReady('p2')">CONFIRMAR</button>
            </div>
        </div>
        <div id="connectionStatus" style="margin-top: 20px; color: #888; font-family: 'Roboto'; font-size: 0.8em;">Iniciando PeerJS...</div>
    </div>

    <div id="hostPanel" class="host-panel" style="display:none;">
        <div style="font-size: 0.7em; color: white; margin-bottom: 5px;">PAINEL DO HOST</div>
        <button onclick="copyLink('p2')">COPIAR LINK P2</button>
        <button onclick="resetDraft()" style="color: red;">RESET</button>
    </div>

    <div class="timer-display" id="timerDisplay">45</div>

    <div class="main-container">
        <div class="god-groups-container">
            <div id="p1-god-0" class="god-slot" onclick="clickSlot('p1', 'god', 0)"></div>
            <div id="p2-god-0" class="god-slot" onclick="clickSlot('p2', 'god', 0)"></div>
        </div>
    </div>

    <button id="confirmBtn" class="confirm-btn" onclick="confirmTurn()">CONFIRMAR ESCOLHA</button>

    <script>
        // CONFIGURAÇÕES E ESTADO
        const PEER_CONFIG = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        let state = {
            phaseIndex: -1,
            p1Ready: false, p2Ready: false,
            p1Presence: false, p2Presence: false,
            selections: {},
            p1Name: "Player 1", p2Name: "Player 2"
        };

        let myRole = 'host';
        let peer = null;
        let connections = [];
        let lobbyID = new URLSearchParams(window.location.search).get('lobby');
        let roleParam = new URLSearchParams(window.location.search).get('role');

        // INICIALIZAÇÃO
        function init() {
            if (!lobbyID) {
                myRole = 'host';
                document.getElementById('hostPanel').style.display = 'block';
                setupHost();
            } else {
                myRole = roleParam || 'spec';
                setupClient(lobbyID);
            }
            render();
        }

        // LÓGICA DE CONEXÃO (HOST)
        function setupHost() {
            peer = new Peer(PEER_CONFIG);
            
            peer.on('open', id => {
                const url = `${window.location.origin}${window.location.pathname}?lobby=${id}&role=p2`;
                console.log("Lobby ID:", id);
                document.getElementById('connectionStatus').innerText = "Host Pronto. Envie o link para o P2.";
                window.p2Link = url;
            });

            peer.on('connection', conn => {
                console.log("P2 conectado!");
                connections.push(conn);
                setupConnListeners(conn);
            });
        }

        // LÓGICA DE CONEXÃO (CLIENTE)
        function setupClient(id) {
            peer = new Peer(PEER_CONFIG);
            
            peer.on('open', () => {
                const conn = peer.connect(id, { reliable: true });
                connections.push(conn);
                setupConnListeners(conn);
            });

            peer.on('error', err => {
                document.getElementById('connectionStatus').innerText = "Erro de conexão: " + err.type;
            });
        }

        function setupConnListeners(conn) {
            conn.on('open', () => {
                document.getElementById('connectionStatus').innerText = "Conexão Estabelecida!";
                if (myRole === 'host') conn.send({ type: 'STATE', state });
            });

            conn.on('data', data => {
                if (data.type === 'STATE') {
                    state = data.state;
                    render();
                } else if (data.type === 'ACTION' && myRole === 'host') {
                    handleAction(data);
                }
            });
        }

        // LÓGICA DO DRAFT
        function toggleReady(player) {
            // Regra de segurança: Host pode confirmar qualquer um, P2 só ele mesmo.
            if (myRole === 'host' || (myRole === 'p2' && player === 'p2')) {
                const action = { type: 'ACTION', action: 'TOGGLE_READY', payload: { player } };
                
                if (myRole === 'host') {
                    handleAction(action);
                } else {
                    connections[0].send(action);
                }
            }
        }

        function handleAction(msg) {
            if (msg.action === 'TOGGLE_READY') {
                if (msg.payload.player === 'p1') state.p1Presence = !state.p1Presence;
                if (msg.payload.player === 'p2') state.p2Presence = !state.p2Presence;
                
                // Se ambos derem OK, inicia
                if (state.p1Presence && state.p2Presence) {
                    state.phaseIndex = 0;
                }
            }
            
            if (myRole === 'host') broadcast();
        }

        function broadcast() {
            render();
            connections.forEach(c => c.send({ type: 'STATE', state }));
        }

        function render() {
            const overlay = document.getElementById('readyOverlay');
            
            // Lobby
            if (state.phaseIndex === -1) {
                overlay.style.display = 'flex';
                document.getElementById('p1ReadyBox').className = state.p1Presence ? 'ready-box ready' : 'ready-box';
                document.getElementById('p2ReadyBox').className = state.p2Presence ? 'ready-box ready' : 'ready-box';
            } else {
                overlay.style.display = 'none';
            }
            
            // Aqui entraria a renderização dos deuses (seu código original)
        }

        function copyLink() {
            navigator.clipboard.writeText(window.p2Link);
            alert("Link copiado! Mande para o adversário.");
        }

        init();
    </script>
</body>
</html>
