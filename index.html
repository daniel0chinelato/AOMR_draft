<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AoM Draft - COM LINKS VISÍVEIS</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #050505;
            color: white; font-family: 'Cinzel', serif;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; min-height: 100vh;
            background-image: url('fundooo.png'); background-size: cover;
        }

        /* --- ÁREA DE LINKS (A QUE VOCÊ QUER) --- */
        .links-area {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #f1c40f;
            padding: 20px;
            margin: 20px 0;
            width: 80%; max-width: 600px;
            text-align: left;
            border-radius: 8px;
            display: none; /* Aparece via JS */
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.2);
            z-index: 10001; /* Fica acima de tudo */
        }

        .link-row {
            margin-bottom: 15px;
        }
        .link-row label {
            display: block; color: #f1c40f; font-size: 0.8em; margin-bottom: 5px;
        }
        .input-wrapper {
            display: flex; gap: 10px;
        }
        .link-input {
            flex: 1; background: #222; border: 1px solid #444; color: #fff;
            padding: 10px; font-family: 'Roboto', sans-serif;
            border-radius: 4px;
        }
        .copy-btn {
            background: #f1c40f; color: #000; border: none;
            padding: 0 20px; font-weight: bold; cursor: pointer;
            font-family: 'Roboto'; border-radius: 4px;
        }
        .copy-btn:hover { background: #fff; }

        /* --- RESTO DO VISUAL --- */
        .lobby-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .ready-box {
            border: 1px solid #444; padding: 20px; width: 200px; text-align: center; margin: 10px;
            background: rgba(20,20,20,0.8);
        }
        .ready-box.ready { border-color: #2ecc71; box-shadow: 0 0 15px #2ecc71; }
        .ready-btn {
            width: 100%; padding: 10px; background: transparent; border: 1px solid #555; color: #888; cursor: pointer;
        }
        .ready-btn:hover { border-color: #fff; color: #fff; }
        
        /* Containers do Jogo */
        .main-container { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 50px; }
        .slots-row { display: flex; gap: 10px; margin: 10px; }
        .slot { width: 80px; height: 120px; border: 1px solid #444; background: #111; cursor: pointer; }
        .slot.filled { border-color: gold; }
        .slot img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; z-index: 20000; justify-content:center; align-items:center; }
        .modal-content { width: 80%; height: 80%; background:#111; border: 1px solid gold; overflow-y:auto; display:flex; flex-wrap:wrap; gap:10px; padding:20px; }
        .card { width: 100px; height: 150px; border: 1px solid #333; cursor: pointer; }
        .card:hover { border-color: gold; }
        .card img { width: 100%; height: 100%; }

    </style>
</head>
<body>

    <div id="lobbyOverlay" class="lobby-overlay">
        <h1 style="color: gold; letter-spacing: 5px;">LOBBY DE DRAFT</h1>
        
        <div id="linksArea" class="links-area">
            <h3 style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">LINKS PARA CONVIDAR</h3>
            
            <div class="link-row">
                <label>LINK DO JOGADOR 2 (Adversário):</label>
                <div class="input-wrapper">
                    <input type="text" id="linkP2" class="link-input" value="Gerando..." readonly onclick="this.select()">
                    <button class="copy-btn" onclick="copyLink('linkP2')">COPIAR</button>
                </div>
            </div>

            <div class="link-row">
                <label>LINK DE ESPECTADOR:</label>
                <div class="input-wrapper">
                    <input type="text" id="linkSpec" class="link-input" value="Gerando..." readonly onclick="this.select()">
                    <button class="copy-btn" onclick="copyLink('linkSpec')">COPIAR</button>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:20px; margin-top:20px;">
            <div id="boxP1" class="ready-box">
                <h2 style="color:#3498db">PLAYER 1</h2>
                <button id="btnP1" class="ready-btn" onclick="toggleReady('p1')">CONFIRMAR</button>
            </div>
            <div id="boxP2" class="ready-box">
                <h2 style="color:#e74c3c">PLAYER 2</h2>
                <button id="btnP2" class="ready-btn" onclick="toggleReady('p2')">AGUARDANDO...</button>
            </div>
        </div>
        
        <div id="statusMsg" style="margin-top:20px; color:#666; font-family:'Roboto'">Iniciando conexão...</div>
    </div>

    <div class="main-container">
        <div style="font-size: 2em; margin-bottom: 20px;">DRAFT EM ANDAMENTO</div>
        <div class="slots-row" id="p1Slots">
            </div>
        <div style="font-size: 1.5em; color: gold;">VS</div>
        <div class="slots-row" id="p2Slots">
            </div>
    </div>

    <div id="selectionModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
        <div id="modalGrid" class="modal-content"></div>
    </div>

    <script>
        // DADOS
        const GODS = [
            {n:"Zeus", img:"zeus_portrait.png"}, {n:"Poseidon", img:"poseidon_portrait.png"}, 
            {n:"Hades", img:"hades_portrait.png"}, {n:"Isis", img:"isis_portrait.png"}, 
            {n:"Ra", img:"ra_portrait.png"}, {n:"Set", img:"set_portrait.png"},
            {n:"Loki", img:"loki_portrait.png"}, {n:"Thor", img:"thor_portrait.png"},
            {n:"Odin", img:"odin_portrait.png"}, {n:"Gaia", img:"gaia_portrait.png"},
            {n:"Kronos", img:"kronos_portrait.png"}, {n:"Oranos", img:"oranos_portrait.png"}
        ];

        // CONFIGURAÇÃO
        let state = { p1Ready: false, p2Ready: false, selections: {} };
        let myRole = 'host';
        let peer = null;
        let connections = [];

        // INICIALIZAÇÃO
        function init() {
            const params = new URLSearchParams(window.location.search);
            const lobbyId = params.get('lobby');
            const role = params.get('role');

            renderSlots(); // Desenha os quadrados vazios

            if (!lobbyId) {
                // SOU O HOST
                myRole = 'host';
                document.getElementById('btnP1').innerText = "CONFIRMAR (VOCÊ)";
                startHost();
            } else {
                // SOU CLIENTE
                myRole = role || 'spec';
                document.getElementById('linksArea').style.display = 'none'; // Esconde links pra quem não é host
                document.getElementById('btnP1').innerText = "AGUARDANDO P1";
                if(myRole === 'p2') document.getElementById('btnP2').innerText = "CONFIRMAR (VOCÊ)";
                
                connectToHost(lobbyId);
            }
        }

        // --- LÓGICA DO HOST (GERAR LINKS) ---
        function startHost() {
            document.getElementById('statusMsg').innerText = "Criando sala...";
            
            peer = new Peer({
                config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
            });

            peer.on('open', (id) => {
                document.getElementById('statusMsg').innerText = "Sala criada! Copie os links acima.";
                
                // MOSTRAR A CAIXA DE LINKS
                document.getElementById('linksArea').style.display = 'block';

                // GERAR LINKS
                const baseUrl = window.location.href.split('?')[0];
                document.getElementById('linkP2').value = `${baseUrl}?lobby=${id}&role=p2`;
                document.getElementById('linkSpec').value = `${baseUrl}?lobby=${id}&role=spec`;
            });

            peer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('open', () => {
                    // Envia estado atual para quem entrou
                    conn.send({ type: 'STATE', state: state });
                });
                conn.on('data', (data) => handleData(data));
            });
            
            peer.on('error', err => alert("Erro no PeerJS: " + err.type));
        }

        // --- LÓGICA DO CLIENTE ---
        function connectToHost(hostId) {
            document.getElementById('statusMsg').innerText = "Conectando ao Host...";
            
            peer = new Peer();
            peer.on('open', () => {
                const conn = peer.connect(hostId);
                connections.push(conn);
                
                conn.on('open', () => {
                    document.getElementById('statusMsg').innerText = "Conectado!";
                });

                conn.on('data', (data) => handleData(data));
            });
        }

        // --- TROCA DE DADOS ---
        function handleData(data) {
            if (data.type === 'STATE') {
                state = data.state;
                render();
            }
            if (data.type === 'ACTION' && myRole === 'host') {
                // Host processa a ação
                if (data.action === 'READY') {
                    if (data.player === 'p1') state.p1Ready = !state.p1Ready;
                    if (data.player === 'p2') state.p2Ready = !state.p2Ready;
                }
                if (data.action === 'PICK') {
                    state.selections[data.slot] = data.god;
                }
                broadcast();
            }
        }

        function sendAction(action, payload) {
            if (myRole === 'host') {
                // Se eu sou host, eu mesmo processo
                handleData({ type: 'ACTION', action, ...payload });
            } else {
                // Se sou cliente, mando pro host
                connections.forEach(c => c.send({ type: 'ACTION', action, ...payload }));
            }
        }

        function broadcast() {
            render();
            connections.forEach(c => c.send({ type: 'STATE', state: state }));
        }

        // --- UI E INTERAÇÃO ---
        function copyLink(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            alert("Link copiado!");
        }

        function toggleReady(player) {
            if (myRole === 'spec') return;
            if (myRole === 'p2' && player === 'p1') return;
            if (myRole === 'host' && player === 'p2' && connections.length > 0) return; // Host não clica pelo P2 se tiver online
            
            sendAction('READY', { player });
        }

        function render() {
            // Lobby Update
            const box1 = document.getElementById('boxP1');
            const box2 = document.getElementById('boxP2');
            
            if (state.p1Ready) box1.classList.add('ready'); else box1.classList.remove('ready');
            if (state.p2Ready) box2.classList.add('ready'); else box2.classList.remove('ready');

            if (state.p1Ready && state.p2Ready) {
                document.getElementById('lobbyOverlay').style.display = 'none';
            }

            // Slots Update
            for (const [slotId, god] of Object.entries(state.selections)) {
                const el = document.getElementById(slotId);
                if (el) {
                    el.innerHTML = `<img src="${god.img}">`;
                    el.classList.add('filled');
                }
            }
        }

        function renderSlots() {
            const p1c = document.getElementById('p1Slots');
            const p2c = document.getElementById('p2Slots');
            
            for(let i=0; i<3; i++) {
                p1c.innerHTML += `<div id="p1-god-${i}" class="slot" onclick="clickSlot('p1', ${i})"></div>`;
                p2c.innerHTML += `<div id="p2-god-${i}" class="slot" onclick="clickSlot('p2', ${i})"></div>`;
            }
        }

        function clickSlot(player, index) {
            if ((myRole === 'host' && player === 'p1') || (myRole === 'p2' && player === 'p2')) {
                openModal(`${player}-god-${index}`);
            }
        }

        function openModal(slotId) {
            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';
            GODS.forEach(god => {
                grid.innerHTML += `<div class="card" onclick="pickGod('${slotId}', '${god.n}', '${god.img}')"><img src="${god.img}"></div>`;
            });
            document.getElementById('selectionModal').style.display = 'flex';
        }

        function pickGod(slot, name, img) {
            sendAction('PICK', { slot, god: { n: name, img } });
            document.getElementById('selectionModal').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
